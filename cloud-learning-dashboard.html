<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni - Uƒçenje v Oblaku</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .header-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #888;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .overview-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .overview-card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        .active-processes {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .no-processes {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        .process-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .process-item.learning {
            border-left-color: #28a745;
        }

        .process-item.error {
            border-left-color: #dc3545;
        }

        .process-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .process-status {
            font-size: 0.9em;
            color: #666;
        }

        .learning-modules {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .learning-modules h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .module-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .module-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .module-item.learning {
            border-left-color: #3182ce;
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        }

        .module-item.completed {
            border-left-color: #38a169;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }

        .module-item.error {
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .module-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }

        .module-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-icon.completed { background-color: #38a169; }
        .status-icon.learning { background-color: #3182ce; }
        .status-icon.error { background-color: #e53e3e; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.completed {
            background: linear-gradient(90deg, #38a169 0%, #68d391 100%);
        }

        .progress-fill.error {
            background: linear-gradient(90deg, #e53e3e 0%, #fc8181 100%);
        }

        .module-description {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .module-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #718096;
        }

        .learning-process {
            font-style: italic;
            color: #3182ce;
        }

        .timestamp {
            font-size: 0.8rem;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background-color: #c6f6d5;
            color: #22543d;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-indicator.status-completed {
            background-color: #c6f6d5;
            color: #22543d;
        }

        .status-indicator.status-learning {
            background-color: #bee3f8;
            color: #2a4365;
        }

        .status-indicator.status-error {
            background-color: #fed7d7;
            color: #742a2a;
        }

        .connection-status.disconnected {
            background-color: #fed7d7;
            color: #742a2a;
        }

        /* Posodobljeni stili za module */
        .module-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .module-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .module-title h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #2d3748;
        }

        .progress-percentage-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .progress-percentage-badge.completed {
            background: linear-gradient(135deg, #38a169, #68d391);
        }

        .progress-percentage-badge.learning {
            background: linear-gradient(135deg, #3182ce, #63b3ed);
        }

        .progress-percentage-badge.error {
            background: linear-gradient(135deg, #e53e3e, #fc8181);
        }

        .category-lokal {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .category-restavracija {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .category-turizem {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .current-activity {
            margin: 15px 0;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #3182ce;
        }

        .sub-modules {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .sub-modules h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .sub-module {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .sub-module-name {
            flex: 1;
            font-size: 0.85rem;
            color: #2d3748;
        }

        .sub-progress-bar {
            width: 80px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .sub-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .sub-progress-fill.completed {
            background: #38a169;
        }

        .sub-progress-fill.learning {
            background: #3182ce;
        }

        .sub-progress-fill.error {
            background: #e53e3e;
        }

        .sub-progress-text {
            font-size: 0.8rem;
            color: #718096;
            min-width: 35px;
        }

        .module-category {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }

        .module-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.85rem;
            color: #718096;
        }

        .active-process {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #3182ce;
        }

        .process-info {
            flex: 1;
        }

        .process-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3748;
        }

        .process-description {
            font-size: 0.9em;
            color: #666;
        }

        .process-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
        }

        .progress-percentage {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            min-width: 35px;
        }

        /* Stili za kategorije */
        .modules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .category-filters {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .category-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e2e8f0;
        }

        .category-card.lokal {
            border-left-color: #667eea;
        }

        .category-card.restavracija {
            border-left-color: #f093fb;
        }

        .category-card.turizem {
            border-left-color: #4facfe;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .category-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #2d3748;
        }

        .category-progress {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            background: #f7fafc;
            color: #4a5568;
        }

        .category-modules {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .category-module-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .module-name-small {
            font-weight: 500;
            color: #2d3748;
        }

        .module-status-small {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Omni - Uƒçenje v Oblaku</h1>
            <p>Realtime prikaz napredka samodejnega uƒçenja</p>
            <div class="header-info">
                <span>Zadnja posodobitev: <span id="lastUpdate">-</span></span>
            </div>
        </div>

        <div class="connection-status" id="connectionStatus">
            üî¥ Povezovanje...
        </div>

        <div class="dashboard">
            <div class="overview-card">
                <h2>üìä Pregled Sistema</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalModules">0</div>
                        <div class="stat-label">Skupaj Modulov</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completedModules">0</div>
                        <div class="stat-label">Dokonƒçano</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="learningModules">0</div>
                        <div class="stat-label">V Uƒçenju</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="errorModules">0</div>
                        <div class="stat-label">Napake</div>
                    </div>
                </div>
            </div>

            <div class="overview-card">
                <h2>‚ö° Sistemska Aktivnost</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="systemUptime">0s</div>
                        <div class="stat-label">ƒåas Delovanja</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="learningEfficiency">0%</div>
                        <div class="stat-label">Uƒçinkovitost</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="expansionRate">0</div>
                        <div class="stat-label">Hitrost ≈†irjenja</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="systemStability">0%</div>
                        <div class="stat-label">Stabilnost</div>
                    </div>
                </div>
                <div class="system-status-container" style="margin-top: 15px; text-align: center;">
                    <div id="systemStatus" class="status-indicator status-learning">Inicializacija...</div>
                </div>
            </div>
        </div>

        <div class="learning-modules">
            <div class="modules-header">
                <h2>üìä Status samodejnega uƒçenja</h2>
                <div class="category-filters">
                    <button class="filter-btn active" data-category="all">Vse</button>
                    <button class="filter-btn" data-category="Lokal">üè™ Lokal</button>
                    <button class="filter-btn" data-category="Restavracija">üçΩÔ∏è Restavracija</button>
                    <button class="filter-btn" data-category="Turizem">üèñÔ∏è Turizem</button>
                </div>
            </div>
            <div class="category-summary">
                <div class="category-card lokal">
                    <div class="category-header">
                        <h3>üè™ Lokal (POS, tiskalniki, zaloge)</h3>
                        <span class="category-progress">75% üü¢</span>
                    </div>
                    <div class="category-modules" id="lokalModules"></div>
                </div>
                <div class="category-card restavracija">
                    <div class="category-header">
                        <h3>üçΩÔ∏è Restavracija (rezervacije, HACCP)</h3>
                        <span class="category-progress">40% üîµ</span>
                    </div>
                    <div class="category-modules" id="restavracijaModules"></div>
                </div>
                <div class="category-card turizem">
                    <div class="category-header">
                        <h3>üèñÔ∏è Turizem (prenoƒçi≈°ƒça, vodiƒç, eTurizem)</h3>
                        <span class="category-progress">20% üîµ</span>
                    </div>
                    <div class="category-modules" id="turizemModules"></div>
                </div>
            </div>
            <div id="modulesList">
                <!-- Moduli se bodo dinamiƒçno nalo≈æili -->
            </div>
        </div>

        <div class="active-processes">
            <h2>‚ö° Aktivni Procesi</h2>
            <div id="activeProcessesList">
                <!-- Aktivni procesi se bodo dinamiƒçno nalo≈æili -->
            </div>
        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
        üîÑ
    </button>

    <script>
        class CloudLearningDashboard {
            constructor() {
                this.apiBaseUrl = '/api/cloud-learning';
                this.data = null;
                this.updateInterval = null;
                this.websocket = null;
                this.init();
            }

            async init() {
                await this.loadInitialData();
                this.renderDashboard();
                this.startRealTimeUpdates();
                this.setupWebSocket();
                this.setupEventListeners();
            }

            async loadInitialData() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/status`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const result = await response.json();
                    
                    if (result.success) {
                        this.data = result.data;
                        this.renderDashboard();
                    } else {
                        console.error('Napaka pri nalaganju podatkov:', result.error);
                        this.loadMockData(); // Fallback na simulirane podatke
                    }
                } catch (error) {
                    console.error('Napaka pri povezavi z API:', error);
                    this.loadMockData(); // Fallback na simulirane podatke
                }
            }

            loadMockData() {
                // Simulirani podatki za demonstracijo (fallback)
                this.data = {
                    metrics: {
                        totalModules: 8,
                        completedModules: 3,
                        learningModules: 2,
                        errorModules: 1,
                        learningEfficiency: 75,
                        expansionRate: 4,
                        systemStability: 85,
                        startTime: Date.now() - 3600000
                    },
                    uptime: 3600000,
                    modules: [
                        {
                            id: 'predictive_analytics',
                            name: 'Predictive Analytics',
                            category: 'AI/ML',
                            status: 'completed',
                            progress: 100,
                            description: 'Uƒçenje naprednih algoritmov za napovedovanje trendov',
                            currentProcess: 'Uspe≈°no zakljuƒçeno',
                            priority: 'high',
                            lastUpdate: new Date(Date.now() - 300000),
                            metrics: { accuracy: 0.94, performance: 'excellent' }
                        },
                        {
                            id: 'system_integration',
                            name: 'System Integration',
                            category: 'Infrastructure',
                            status: 'learning',
                            progress: 67,
                            description: 'Integracija razliƒçnih sistemskih komponent',
                            currentProcess: 'Testiranje API povezav',
                            priority: 'high',
                            lastUpdate: new Date(),
                            metrics: { accuracy: 0.78, performance: 'good' }
                        },
                        {
                            id: 'pattern_recognition',
                            name: 'Pattern Recognition',
                            category: 'AI/ML',
                            status: 'learning',
                            progress: 34,
                            description: 'Prepoznavanje vzorcev v podatkih',
                            currentProcess: 'Analiza podatkovnih struktur',
                            priority: 'medium',
                            lastUpdate: new Date(Date.now() - 30000),
                            metrics: { accuracy: 0.65, performance: 'good' }
                        },
                        {
                            id: 'pos_printer_integration',
                            name: 'POS ‚Üí Tiskalnik',
                            category: 'Hardware',
                            status: 'error',
                            progress: 23,
                            description: 'Testiranje povezave POS ‚Üí tiskalnik',
                            currentProcess: 'Napaka: Connection timeout',
                            priority: 'medium',
                            lastUpdate: new Date(Date.now() - 120000),
                            metrics: { accuracy: 0.45, performance: 'poor' }
                        }
                    ],
                    activeProcesses: 2,
                    isRunning: true
                };
                
                // Prika≈æemo podatke po nalaganju
                this.renderDashboard();
            }

            setupWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        console.log('üîå WebSocket povezava vzpostavljena');
                    };
                    
                    this.websocket.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleWebSocketMessage(message);
                        } catch (error) {
                            console.error('Napaka pri obdelavi WebSocket sporoƒçila:', error);
                        }
                    };
                    
                    this.websocket.onclose = () => {
                        console.log('üîå WebSocket povezava zaprta');
                        // Poskusi ponovno povezavo po 5 sekundah
                        setTimeout(() => this.setupWebSocket(), 5000);
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket napaka:', error);
                    };
                } catch (error) {
                    console.error('Napaka pri vzpostavljanju WebSocket povezave:', error);
                }
            }

            handleWebSocketMessage(message) {
                switch (message.type) {
                    case 'initialStatus':
                    case 'systemUpdate':
                        this.data = message.data;
                        this.renderDashboard();
                        break;
                    case 'progressUpdate':
                        this.updateModuleInData(message.data);
                        this.renderDashboard();
                        break;
                    case 'learningStarted':
                    case 'learningCompleted':
                        this.updateModuleInData(message.data);
                        this.renderDashboard();
                        break;
                    default:
                        console.log('Neznano WebSocket sporoƒçilo:', message);
                }
            }

            updateModuleInData(moduleData) {
                if (!this.data || !this.data.modules) return;
                
                const moduleIndex = this.data.modules.findIndex(m => m.id === moduleData.id);
                if (moduleIndex !== -1) {
                    this.data.modules[moduleIndex] = { ...this.data.modules[moduleIndex], ...moduleData };
                }
            }

            async startRealTimeUpdates() {
                // Periodiƒçno posodabljanje preko API (backup za WebSocket)
                this.updateInterval = setInterval(async () => {
                    if (!this.websocket || this.websocket.readyState !== WebSocket.OPEN) {
                        await this.loadInitialData();
                        this.renderDashboard();
                    }
                }, 10000); // Vsakih 10 sekund
            }

            async restartModule(moduleId) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/modules/${moduleId}/restart`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log(`Modul ${moduleId} ponovno zagnan`);
                        await this.loadInitialData();
                        this.renderDashboard();
                    } else {
                        console.error('Napaka pri ponovnem zagonu:', result.error);
                    }
                } catch (error) {
                    console.error('Napaka pri ponovnem zagonu modula:', error);
                }
            }
            renderDashboard() {
                if (!this.data) return;

                // Posodobi sistemske metrike
                this.updateSystemMetricsDisplay();
                
                // Posodobi seznam modulov
                this.updateModulesDisplay();
                
                // Posodobi aktivne procese
                this.updateActiveProcessesDisplay();
                
                // Posodobi zadnje posodabljanje
                document.getElementById('lastUpdate').textContent = 
                    new Date().toLocaleTimeString('sl-SI');
            }

            updateSystemMetricsDisplay() {
                if (!this.data || !this.data.metrics) {
                    console.warn('Ni podatkov za prikaz metrik');
                    return;
                }
                
                const metrics = this.data.metrics;
                
                // Varno posodabljanje elementov
                const updateElement = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    } else {
                        console.warn(`Element z ID '${id}' ni najden`);
                    }
                };
                
                updateElement('totalModules', metrics.totalModules || 0);
                updateElement('completedModules', metrics.completedModules || 0);
                updateElement('learningModules', metrics.learningModules || 0);
                updateElement('errorModules', metrics.errorModules || 0);
                updateElement('learningEfficiency', `${metrics.learningEfficiency || 0}%`);
                updateElement('expansionRate', `${metrics.expansionRate || 0}/min`);
                updateElement('systemStability', `${metrics.systemStability || 0}%`);
                
                // Posodobi uptime
                const uptimeHours = Math.floor((this.data.uptime || 0) / 3600000);
                const uptimeMinutes = Math.floor(((this.data.uptime || 0) % 3600000) / 60000);
                updateElement('systemUptime', `${uptimeHours}h ${uptimeMinutes}m`);
                
                // Posodobi status indikator
                const statusIndicator = document.getElementById('systemStatus');
                if (statusIndicator) {
                    const stability = metrics.systemStability || 0;
                    if (stability >= 80) {
                        statusIndicator.className = 'status-indicator status-completed';
                        statusIndicator.textContent = 'Stabilno';
                    } else if (stability >= 60) {
                        statusIndicator.className = 'status-indicator status-learning';
                        statusIndicator.textContent = 'Opozorilo';
                    } else {
                        statusIndicator.className = 'status-indicator status-error';
                        statusIndicator.textContent = 'Nestabilno';
                    }
                } else {
                    console.warn('Element systemStatus ni najden');
                }
            }

            updateModulesDisplay() {
                const modulesList = document.getElementById('modulesList');
                modulesList.innerHTML = '';

                // Posodobi kategorije
                this.updateCategoryModules();

                // Prika≈æi module glede na aktivni filter
                const activeFilter = document.querySelector('.filter-btn.active')?.dataset.category || 'all';
                const filteredModules = activeFilter === 'all' 
                    ? this.data.modules 
                    : this.data.modules.filter(m => m.category === activeFilter);

                filteredModules.forEach(module => {
                    const moduleElement = this.createModuleElement(module);
                    modulesList.appendChild(moduleElement);
                });
            }

            updateCategoryModules() {
                const categories = {
                    'Lokal': { container: 'lokalModules', modules: [] },
                    'Restavracija': { container: 'restavracijaModules', modules: [] },
                    'Turizem': { container: 'turizemModules', modules: [] }
                };

                // Razvrsti module po kategorijah
                this.data.modules.forEach(module => {
                    if (categories[module.category]) {
                        categories[module.category].modules.push(module);
                    }
                });

                // Posodobi vsako kategorijo
                Object.keys(categories).forEach(categoryName => {
                    const category = categories[categoryName];
                    const container = document.getElementById(category.container);
                    if (container) {
                        container.innerHTML = '';
                        
                        category.modules.forEach(module => {
                            const moduleItem = document.createElement('div');
                            moduleItem.className = 'category-module-item';
                            moduleItem.innerHTML = `
                                <span class="module-name-small">${module.name}</span>
                                <div class="module-status-small">
                                    <span>${module.progress}%</span>
                                    <span>${this.getStatusEmoji(module.status, module.progress)}</span>
                                </div>
                            `;
                            container.appendChild(moduleItem);
                        });

                        if (category.modules.length === 0) {
                            container.innerHTML = '<div class="no-modules">Ni modulov</div>';
                        }
                    }
                });

                // Posodobi napredek kategorij
                this.updateCategoryProgress();
            }

            updateCategoryProgress() {
                const categories = {
                    'Lokal': this.data.modules.filter(m => m.category === 'Lokal'),
                    'Restavracija': this.data.modules.filter(m => m.category === 'Restavracija'),
                    'Turizem': this.data.modules.filter(m => m.category === 'Turizem')
                };

                Object.keys(categories).forEach(categoryName => {
                    const modules = categories[categoryName];
                    if (modules.length > 0) {
                        const avgProgress = modules.reduce((sum, m) => sum + m.progress, 0) / modules.length;
                        const progressElement = document.querySelector(`.category-card.${categoryName.toLowerCase()} .category-progress`);
                        if (progressElement) {
                            const emoji = avgProgress >= 70 ? 'üü¢' : avgProgress >= 40 ? 'üîµ' : 'üî¥';
                            progressElement.textContent = `${Math.round(avgProgress)}% ${emoji}`;
                        }
                    }
                });
            }

            createModuleElement(module) {
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'module-card';
                
                // Doloƒçi barvo glede na napredek in status
                const progressColor = this.getProgressColor(module.progress, module.status);
                const statusEmoji = this.getStatusEmoji(module.status, module.progress);
                
                moduleDiv.innerHTML = `
                    <div class="module-header">
                        <div class="module-title">
                            <div class="status-icon ${module.status}"></div>
                            <h3>${module.name}</h3>
                            <span class="progress-percentage-badge ${module.status}">${Math.round(module.progress)}% ${statusEmoji}</span>
                        </div>
                        <div class="module-category category-${module.category ? module.category.toLowerCase().replace(/[^a-z0-9]/g, '') : 'default'}">${module.category || 'Splo≈°no'}</div>
                    </div>
                    <div class="module-description">${module.description}</div>
                    <div class="progress-bar">
                        <div class="progress-fill ${module.status}" style="width: ${module.progress}%; background: ${progressColor}"></div>
                    </div>
                    <div class="current-activity">
                        <strong>Trenutno:</strong> <span class="learning-process">${module.currentProcess}</span>
                    </div>
                    ${module.subModules && module.subModules.length > 0 ? `
                        <div class="sub-modules">
                            <h4>Podmoduli:</h4>
                            ${module.subModules.map(sub => `
                                <div class="sub-module">
                                    <span class="sub-module-name">${sub.name}</span>
                                    <div class="sub-progress-bar">
                                        <div class="sub-progress-fill ${sub.status}" style="width: ${sub.progress}%"></div>
                                    </div>
                                    <span class="sub-progress-text">${sub.progress}%</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="module-details">
                        <span class="accuracy">Natanƒçnost: ${Math.round((module.metrics?.accuracy || 0) * 100)}%</span>
                        <span class="timestamp">${module.lastUpdate.toLocaleTimeString('sl-SI')}</span>
                    </div>
                    <div class="module-actions">
                        ${module.status === 'error' ? `
                            <div class="error-actions">
                                <button class="restart-btn" onclick="dashboard.restartModule('${module.id}')">
                                    üîÑ Ponovno za≈æeni
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                return moduleDiv;
            }

            getProgressColor(progress, status) {
                if (status === 'error') return 'linear-gradient(90deg, #e53e3e 0%, #fc8181 100%)';
                if (status === 'completed') return 'linear-gradient(90deg, #38a169 0%, #68d391 100%)';
                
                // Dinamiƒçna barva glede na napredek
                if (progress >= 80) return 'linear-gradient(90deg, #38a169 0%, #68d391 100%)';
                if (progress >= 60) return 'linear-gradient(90deg, #3182ce 0%, #63b3ed 100%)';
                if (progress >= 40) return 'linear-gradient(90deg, #d69e2e 0%, #f6e05e 100%)';
                return 'linear-gradient(90deg, #e53e3e 0%, #fc8181 100%)';
            }

            getStatusEmoji(status, progress) {
                if (status === 'completed') return 'üü¢';
                if (status === 'error') return 'üî¥';
                if (progress >= 60) return 'üîµ';
                return 'üîµ';
            }

            updateActiveProcessesDisplay() {
                const activeProcessesList = document.getElementById('activeProcessesList');
                activeProcessesList.innerHTML = '';

                const activeModules = this.data.modules.filter(m => m.status === 'learning');
                
                if (activeModules.length === 0) {
                    activeProcessesList.innerHTML = '<div class="no-processes">Ni aktivnih procesov</div>';
                    return;
                }

                activeModules.forEach(module => {
                    const processElement = document.createElement('div');
                    processElement.className = 'active-process';
                    processElement.innerHTML = `
                        <div class="process-info">
                            <div class="process-name">${module.name}</div>
                            <div class="process-description">${module.currentProcess}</div>
                        </div>
                        <div class="process-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${module.progress}%"></div>
                            </div>
                            <span class="progress-percentage">${Math.round(module.progress)}%</span>
                        </div>
                    `;
                    activeProcessesList.appendChild(processElement);
                });
            }

            getStatusColor(status) {
                switch (status) {
                    case 'completed': return '#4CAF50';
                    case 'learning': return '#2196F3';
                    case 'error': return '#f44336';
                    case 'pending': return '#FF9800';
                    default: return '#9E9E9E';
                }
            }

            setupEventListeners() {
                // Gumb za osve≈æitev
                document.getElementById('refreshBtn').addEventListener('click', async () => {
                    await this.loadInitialData();
                    this.renderDashboard();
                });

                // Gumb za zaustavitev/zagon
                document.getElementById('toggleBtn').addEventListener('click', () => {
                    // Implementiraj zaustavitev/zagon sistema
                    console.log('Toggle system status');
                });

                // Filtri kategorij
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Odstrani active razred z vseh gumbov
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        // Dodaj active razred na kliknjen gumb
                        e.target.classList.add('active');
                        // Posodobi prikaz modulov
                        this.updateModulesDisplay();
                    });
                });
            }

            cleanup() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                if (this.websocket) {
                    this.websocket.close();
                }
            }
        }

        // Inicializiraj dashboard
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new CloudLearningDashboard();
        });

        // Poƒçisti ob zaprtju strani
        window.addEventListener('beforeunload', () => {
            if (dashboard) {
                dashboard.cleanup();
            }
        });

        // Simulirani podatki za demo
        const demoModules = [
            {
                id: 'predictive_analytics',
                name: 'Predictive Analytics',
                status: 'learning',
                progress: 73,
                description: 'Uƒçenje naprednih algoritmov za napovedovanje trendov in vzorcev',
                currentProcess: 'Testiranje neural network modelov',
                lastUpdate: new Date(),
                details: {
                    accuracy: 0.87,
                    performance: 'good',
                    estimatedCompletion: '15 min'
                }
            },
            {
                id: 'system_integration',
                name: 'System Integration',
                status: 'completed',
                progress: 100,
                description: 'Integracija razliƒçnih sistemskih komponent in API-jev',
                currentProcess: 'Stabilno delovanje',
                lastUpdate: new Date(Date.now() - 300000),
                details: {
                    accuracy: 0.98,
                    performance: 'excellent',
                    completedAt: new Date(Date.now() - 300000)
                }
            },
            {
                id: 'pattern_recognition',
                name: 'Pattern Recognition',
                status: 'learning',
                progress: 45,
                description: 'Prepoznavanje vzorcev v podatkih in avtomatizacija procesov',
                currentProcess: 'Analiza kompleksnih podatkovnih struktur',
                lastUpdate: new Date(),
                details: {
                    accuracy: 0.72,
                    performance: 'good',
                    estimatedCompletion: '25 min'
                }
            },
            {
                id: 'pos_printer_integration',
                name: 'POS ‚Üí Tiskalnik',
                status: 'error',
                progress: 25,
                description: 'Testiranje povezave med POS sistemom in tiskalniki',
                currentProcess: 'Napaka pri komunikaciji - potrebno roƒçno posredovanje',
                lastUpdate: new Date(),
                details: {
                    error: 'Connection timeout',
                    lastAttempt: new Date(),
                    retryCount: 3
                }
            },
            {
                id: 'adaptive_learning',
                name: 'Adaptive Learning',
                status: 'learning',
                progress: 89,
                description: 'Prilagajanje uƒçnih algoritmov na podlagi povratnih informacij',
                currentProcess: 'Optimizacija hiperparametrov',
                lastUpdate: new Date(),
                details: {
                    accuracy: 0.94,
                    performance: 'excellent',
                    estimatedCompletion: '5 min'
                }
            },
            {
                id: 'optimization_algorithms',
                name: 'Optimization Algorithms',
                status: 'learning',
                progress: 62,
                description: 'Razvoj algoritmov za optimizacijo sistemskih virov',
                currentProcess: 'Testiranje genetskih algoritmov',
                lastUpdate: new Date(),
                details: {
                    accuracy: 0.81,
                    performance: 'good',
                    estimatedCompletion: '18 min'
                }
            }
        ];

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusEl.textContent = 'üü¢ Povezano';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'üî¥ Ni povezave';
                statusEl.className = 'connection-status disconnected';
            }
        }

        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds/60)}m`;
            return `${Math.floor(seconds/3600)}h ${Math.floor((seconds%3600)/60)}m`;
        }

        function updateStats(modules) {
            const total = modules.length;
            const completed = modules.filter(m => m.status === 'completed').length;
            const learning = modules.filter(m => m.status === 'learning').length;
            const errors = modules.filter(m => m.status === 'error').length;

            document.getElementById('totalModules').textContent = total;
            document.getElementById('completedModules').textContent = completed;
            document.getElementById('learningModules').textContent = learning;
            document.getElementById('errorModules').textContent = errors;

            // Simulirani sistemski podatki
            const uptime = Math.floor((Date.now() - (Date.now() - 3600000)) / 1000);
            const efficiency = Math.round((completed / total) * 100);
            const expansionRate = learning * 2;
            const stability = Math.max(0, 100 - (errors * 20));

            document.getElementById('systemUptime').textContent = formatTime(uptime);
            document.getElementById('learningEfficiency').textContent = `${efficiency}%`;
            document.getElementById('expansionRate').textContent = expansionRate;
            document.getElementById('systemStability').textContent = `${stability}%`;
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'üü¢';
                case 'learning': return 'üîµ';
                case 'error': return 'üî¥';
                default: return '‚ö™';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'completed': return 'Dokonƒçano';
                case 'learning': return 'V uƒçenju';
                case 'error': return 'Napaka';
                default: return 'Neznano';
            }
        }

        function renderModules(modules) {
            const modulesList = document.getElementById('modulesList');
            
            modulesList.innerHTML = modules.map(module => `
                <div class="module-item ${module.status}">
                    <div class="module-header">
                        <div class="module-name">${module.name}</div>
                        <div class="module-status">
                            <span class="status-icon ${module.status}"></span>
                            ${getStatusIcon(module.status)} ${getStatusText(module.status)}
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill ${module.status}" style="width: ${module.progress}%"></div>
                    </div>
                    
                    <div class="module-description">
                        ${module.description}
                    </div>
                    
                    <div class="learning-process">
                        ${module.currentProcess}
                    </div>
                    
                    <div class="module-details">
                        <span>Napredek: ${module.progress}%</span>
                        <span class="timestamp">
                            Posodobljeno: ${module.lastUpdate.toLocaleTimeString('sl-SI')}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        async function fetchLearningData() {
            try {
                const response = await fetch('/api/learning/status');
                if (response.ok) {
                    const data = await response.json();
                    updateConnectionStatus(true);
                    return data;
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.log('Using demo data:', error.message);
                updateConnectionStatus(false);
                return {
                    modules: demoModules.map(module => ({
                        ...module,
                        progress: Math.min(100, module.progress + Math.random() * 5),
                        lastUpdate: new Date()
                    }))
                };
            }
        }

        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('spinning');
            
            try {
                const data = await fetchLearningData();
                updateStats(data.modules || demoModules);
                renderModules(data.modules || demoModules);
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateConnectionStatus(false);
            } finally {
                setTimeout(() => {
                    refreshBtn.classList.remove('spinning');
                }, 500);
            }
        }

        // Inicializacija
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            
            // Avtomatsko osve≈æitev vsakih 5 sekund
            refreshInterval = setInterval(refreshData, 5000);
        });

        // ƒåi≈°ƒçenje ob zaprtju strani
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>