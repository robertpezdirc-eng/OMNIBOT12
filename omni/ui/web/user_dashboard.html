<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni - Upravljanje Uporabnikov</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 25px;
            border: 2px solid #e9ecef;
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }

        .role-admin { background: #dc3545; }
        .role-manager { background: #ffc107; color: #000; }
        .role-operator { background: #17a2b8; }
        .role-viewer { background: #28a745; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #000; }
        .notification.info { background: #17a2b8; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .users-table {
                font-size: 0.8em;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="user-info">
                <div>
                    <h1>üë• Upravljanje Uporabnikov</h1>
                    <p>Nadzorna plo≈°ƒça za upravljanje uporabnikov in vlog</p>
                </div>
                <div class="user-badge">
                    <span>Prijavljen kot:</span>
                    <strong id="currentUser">Nalaganje...</strong>
                    <span id="currentUserRole" class="role-badge">-</span>
                    <button class="btn btn-danger" onclick="logout()">Odjava</button>
                </div>
            </div>
        </div>

        <!-- Statistike -->
        <div class="card">
            <h2>üìä Statistike Uporabnikov</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="loading"></div>
            </div>
        </div>

        <!-- Glavna vsebina -->
        <div class="main-content">
            <!-- Upravljanje uporabnikov -->
            <div class="card">
                <h2>üë§ Uporabniki</h2>
                <button class="btn btn-success" onclick="showCreateUserModal()">+ Dodaj Uporabnika</button>
                <div style="overflow-x: auto;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Uporabnik</th>
                                <th>E-po≈°ta</th>
                                <th>Vloga</th>
                                <th>Status</th>
                                <th>Zadnja prijava</th>
                                <th>Akcije</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="6" class="text-center"><div class="loading"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vloge in dovoljenja -->
            <div class="card">
                <h2>üîê Vloge in Dovoljenja</h2>
                <div id="rolesContainer">
                    <div class="loading"></div>
                </div>
            </div>
        </div>

        <!-- Aktivne seje -->
        <div class="card full-width">
            <h2>üîó Aktivne Seje</h2>
            <div style="overflow-x: auto;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Uporabnik</th>
                            <th>Vloga</th>
                            <th>Zaƒçetek seje</th>
                            <th>Zadnja aktivnost</th>
                            <th>IP naslov</th>
                            <th>Akcije</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                        <tr><td colspan="6" class="text-center"><div class="loading"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal za ustvarjanje/urejanje uporabnika -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserModal()">&times;</span>
            <h2 id="modalTitle">Dodaj Uporabnika</h2>
            <form id="userForm">
                <div class="form-group">
                    <label for="username">Uporabni≈°ko ime:</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="email">E-po≈°ta:</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="firstName">Ime:</label>
                    <input type="text" id="firstName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Priimek:</label>
                    <input type="text" id="lastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Geslo:</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="role">Vloga:</label>
                    <select id="role" class="form-control" required>
                        <option value="">Izberi vlogo...</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Shrani</button>
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Prekliƒçi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal za dovoljenja -->
    <div id="permissionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePermissionsModal()">&times;</span>
            <h2 id="permissionsModalTitle">Dovoljenja</h2>
            <div id="permissionsContent">
                <div class="loading"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let users = [];
        let roles = [];
        let permissions = [];
        let editingUserId = null;

        // Inicializacija
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadData();
            
            // Periodiƒçno osve≈æevanje
            setInterval(loadData, 30000);
        });

        // Preverjanje avtentifikacije
        function checkAuth() {
            const token = localStorage.getItem('omni_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // Dekodiranje tokena za pridobitev uporabni≈°kih podatkov
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;
                
                document.getElementById('currentUser').textContent = payload.username;
                const roleElement = document.getElementById('currentUserRole');
                roleElement.textContent = payload.role;
                roleElement.className = `role-badge role-${payload.role}`;
                
                // Preverjanje dovoljenj
                if (!payload.permissions.includes('users.view')) {
                    showNotification('Nimate dovoljenja za ogled te strani', 'error');
                    setTimeout(() => window.location.href = '/', 3000);
                }
            } catch (error) {
                console.error('Napaka pri dekodiranju tokena:', error);
                logout();
            }
        }

        // Nalaganje podatkov
        async function loadData() {
            try {
                await Promise.all([
                    loadUserStats(),
                    loadUsers(),
                    loadRoles(),
                    loadSessions()
                ]);
            } catch (error) {
                console.error('Napaka pri nalaganju podatkov:', error);
                showNotification('Napaka pri nalaganju podatkov', 'error');
            }
        }

        // Nalaganje statistik
        async function loadUserStats() {
            try {
                const response = await apiCall('/api/users/stats');
                const stats = response.data;
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalUsers}</div>
                        <div class="stat-label">Skupaj uporabnikov</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.activeUsers}</div>
                        <div class="stat-label">Aktivni uporabniki</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.activeSessions}</div>
                        <div class="stat-label">Aktivne seje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Object.keys(stats.roleDistribution).length}</div>
                        <div class="stat-label">Razliƒçne vloge</div>
                    </div>
                `;
            } catch (error) {
                console.error('Napaka pri nalaganju statistik:', error);
            }
        }

        // Nalaganje uporabnikov
        async function loadUsers() {
            try {
                const response = await apiCall('/api/users');
                users = response.data;
                
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <strong>${user.firstName} ${user.lastName}</strong><br>
                            <small>@${user.username}</small>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                        <td>
                            <span style="color: ${user.isActive ? '#28a745' : '#dc3545'}">
                                ${user.isActive ? '‚úÖ Aktiven' : '‚ùå Neaktiven'}
                            </span>
                        </td>
                        <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleString('sl-SI') : 'Nikoli'}</td>
                        <td>
                            <div class="action-buttons">
                                ${currentUser.permissions.includes('users.edit') ? 
                                    `<button class="btn btn-warning" onclick="editUser('${user.id}')">‚úèÔ∏è</button>` : ''}
                                ${currentUser.permissions.includes('users.delete') && user.id !== currentUser.userId ? 
                                    `<button class="btn btn-danger" onclick="deleteUser('${user.id}')">üóëÔ∏è</button>` : ''}
                                <button class="btn btn-info" onclick="showUserPermissions('${user.id}')">üîê</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Napaka pri nalaganju uporabnikov:', error);
            }
        }

        // Nalaganje vlog
        async function loadRoles() {
            try {
                const response = await apiCall('/api/users/roles');
                roles = response.data;
                
                const container = document.getElementById('rolesContainer');
                container.innerHTML = roles.map(role => `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">
                            <span class="role-badge role-${role.key}">${role.name}</span>
                        </h4>
                        <p style="margin-bottom: 10px; color: #666;">${role.description}</p>
                        <small style="color: #888;">
                            Dovoljenja: ${role.permissions.length}
                            <button class="btn btn-info btn-sm" onclick="showRolePermissions('${role.key}')" style="margin-left: 10px;">
                                Prika≈æi dovoljenja
                            </button>
                        </small>
                    </div>
                `).join('');
                
                // Posodabljanje select elementa za vloge
                const roleSelect = document.getElementById('role');
                roleSelect.innerHTML = '<option value="">Izberi vlogo...</option>' +
                    roles.map(role => `<option value="${role.key}">${role.name}</option>`).join('');
            } catch (error) {
                console.error('Napaka pri nalaganju vlog:', error);
            }
        }

        // Nalaganje sej
        async function loadSessions() {
            try {
                const response = await apiCall('/api/users/sessions');
                const sessions = response.data;
                
                const tbody = document.getElementById('sessionsTableBody');
                tbody.innerHTML = sessions.map(session => `
                    <tr>
                        <td>${session.username}</td>
                        <td><span class="role-badge role-${session.role}">${session.role}</span></td>
                        <td>${new Date(session.createdAt).toLocaleString('sl-SI')}</td>
                        <td>${new Date(session.lastActivity).toLocaleString('sl-SI')}</td>
                        <td>${session.ipAddress || 'Neznano'}</td>
                        <td>
                            ${currentUser.permissions.includes('system.admin') ? 
                                `<button class="btn btn-danger btn-sm" onclick="terminateSession('${session.sessionId}')">Konƒçaj</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Napaka pri nalaganju sej:', error);
            }
        }

        // API klici
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('omni_token');
            const response = await fetch(`http://localhost:3001${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });

            if (!response.ok) {
                if (response.status === 401) {
                    logout();
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            return await response.json();
        }

        // Prikaz modala za ustvarjanje uporabnika
        function showCreateUserModal() {
            if (!currentUser.permissions.includes('users.create')) {
                showNotification('Nimate dovoljenja za ustvarjanje uporabnikov', 'error');
                return;
            }
            
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Dodaj Uporabnika';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').style.display = 'block';
        }

        // Urejanje uporabnika
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            editingUserId = userId;
            document.getElementById('modalTitle').textContent = 'Uredi Uporabnika';
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;
            document.getElementById('firstName').value = user.firstName;
            document.getElementById('lastName').value = user.lastName;
            document.getElementById('role').value = user.role;
            document.getElementById('password').required = false;
            document.getElementById('userModal').style.display = 'block';
        }

        // Zapiranje modala
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('password').required = true;
        }

        // Shranjevanje uporabnika
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                role: document.getElementById('role').value
            };
            
            const password = document.getElementById('password').value;
            if (password) {
                formData.password = password;
            }
            
            try {
                if (editingUserId) {
                    await apiCall(`/api/users/${editingUserId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    showNotification('Uporabnik uspe≈°no posodobljen', 'success');
                } else {
                    await apiCall('/api/users', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    showNotification('Uporabnik uspe≈°no ustvarjen', 'success');
                }
                
                closeUserModal();
                loadUsers();
                loadUserStats();
            } catch (error) {
                console.error('Napaka pri shranjevanju:', error);
                showNotification('Napaka pri shranjevanju uporabnika', 'error');
            }
        });

        // Brisanje uporabnika
        async function deleteUser(userId) {
            if (!confirm('Ali ste prepriƒçani, da ≈æelite izbrisati tega uporabnika?')) {
                return;
            }
            
            try {
                await apiCall(`/api/users/${userId}`, { method: 'DELETE' });
                showNotification('Uporabnik uspe≈°no izbrisan', 'success');
                loadUsers();
                loadUserStats();
            } catch (error) {
                console.error('Napaka pri brisanju:', error);
                showNotification('Napaka pri brisanju uporabnika', 'error');
            }
        }

        // Prikaz dovoljenj uporabnika
        function showUserPermissions(userId) {
            const user = users.find(u => u.id === userId);
            const role = roles.find(r => r.key === user.role);
            
            if (!role) return;
            
            document.getElementById('permissionsModalTitle').textContent = 
                `Dovoljenja - ${user.firstName} ${user.lastName} (${role.name})`;
            
            const content = document.getElementById('permissionsContent');
            content.innerHTML = `
                <div class="permissions-grid">
                    ${role.permissions.map(perm => `
                        <div class="permission-item">
                            <span style="color: #28a745;">‚úÖ</span>
                            <span>${perm}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('permissionsModal').style.display = 'block';
        }

        // Prikaz dovoljenj vloge
        function showRolePermissions(roleKey) {
            const role = roles.find(r => r.key === roleKey);
            if (!role) return;
            
            document.getElementById('permissionsModalTitle').textContent = 
                `Dovoljenja vloge - ${role.name}`;
            
            const content = document.getElementById('permissionsContent');
            content.innerHTML = `
                <p style="margin-bottom: 15px; color: #666;">${role.description}</p>
                <div class="permissions-grid">
                    ${role.permissions.map(perm => `
                        <div class="permission-item">
                            <span style="color: #28a745;">‚úÖ</span>
                            <span>${perm}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('permissionsModal').style.display = 'block';
        }

        // Zapiranje modala za dovoljenja
        function closePermissionsModal() {
            document.getElementById('permissionsModal').style.display = 'none';
        }

        // Konƒçanje seje
        async function terminateSession(sessionId) {
            if (!confirm('Ali ste prepriƒçani, da ≈æelite konƒçati to sejo?')) {
                return;
            }
            
            try {
                await apiCall(`/api/users/sessions/${sessionId}`, { method: 'DELETE' });
                showNotification('Seja uspe≈°no konƒçana', 'success');
                loadSessions();
            } catch (error) {
                console.error('Napaka pri konƒçanju seje:', error);
                showNotification('Napaka pri konƒçanju seje', 'error');
            }
        }

        // Odjava
        function logout() {
            localStorage.removeItem('omni_token');
            window.location.href = '/login';
        }

        // Prikaz obvestil
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Zapiranje modalov s klikom izven njih
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            const permissionsModal = document.getElementById('permissionsModal');
            
            if (event.target === userModal) {
                closeUserModal();
            }
            if (event.target === permissionsModal) {
                closePermissionsModal();
            }
        }
    </script>
</body>
</html>