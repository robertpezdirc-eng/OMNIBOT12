<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-APP Real-time Smart Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .node {
            border: 3px solid #2c3e50;
            border-radius: 12px;
            padding: 15px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            text-align: center;
            width: 180px;
            min-height: 80px;
            position: absolute;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            user-select: none;
            z-index: 10;
        }

        .node:active {
            cursor: grabbing;
            transform: scale(1.05) rotate(2deg);
        }

        .node:hover {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .node.submodule {
            width: 140px;
            min-height: 60px;
            border-color: #34495e;
            background: linear-gradient(145deg, #ecf0f1, #d5dbdb);
            font-size: 0.9em;
        }

        .node-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .status {
            font-weight: bold;
            margin-top: 8px;
            display: block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .status.active { background: #4caf50; color: white; }
        .status.loading { background: #ff9800; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.idle { background: #9e9e9e; color: white; }

        #links {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .link {
            stroke: #34495e;
            stroke-width: 3px;
            stroke-dasharray: 8,4;
            animation: dash 2s linear infinite;
            opacity: 0.7;
        }

        @keyframes dash {
            to { stroke-dashoffset: 24; }
        }

        .flow-dot {
            r: 6;
            opacity: 0.9;
            animation: flow-move 3s ease-in-out;
        }

        .flow-dot.high-priority {
            fill: #e74c3c;
            r: 8;
            filter: drop-shadow(0 0 8px #e74c3c);
        }

        .flow-dot.medium-priority {
            fill: #f39c12;
            r: 6;
        }

        .flow-dot.low-priority {
            fill: #27ae60;
            r: 4;
        }

        @keyframes flow-move {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        #info-box {
            position: fixed;
            right: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        #controls {
            position: fixed;
            left: 20px;
            top: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 20px;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        #controls input, #controls button {
            margin: 5px 0;
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        #controls input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        #controls button {
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        #controls button:hover {
            background: linear-gradient(145deg, #2980b9, #1f4e79);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .header-controls {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            background: linear-gradient(145deg, #34495e, #2c3e50);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn:hover {
            background: linear-gradient(145deg, #2c3e50, #1a252f);
            transform: translateY(-2px);
        }

        .stats-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 200px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .priority-stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #34495e;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            min-width: 200px;
        }

        .priority-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
        }

        .priority-high { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .priority-medium { background: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .priority-low { background: rgba(39, 174, 96, 0.1); color: #27ae60; }

        .shortcuts {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.8em;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 768px) {
            #controls, #info-box {
                position: relative;
                width: 90%;
                margin: 10px auto;
                max-height: none;
            }
            
            .header-controls {
                position: relative;
                transform: none;
                left: auto;
                top: auto;
                margin: 10px auto;
                width: 90%;
            }
            
            .node {
                width: 140px;
                min-height: 60px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <svg id="links" width="100%" height="100vh"></svg>
        
        <div id="dashboard">
            <div class="node" id="global" style="top:100px; left:50%; transform:translateX(-50%);">
                <div class="node-title">üåê Global Optimizer</div>
                <span class="status loading" id="status-global">‚è≥ Inicializacija...</span>
            </div>
        </div>
    </div>

    <div class="header-controls">
        <button class="btn" onclick="autoLayout()">üìê Auto Layout</button>
        <button class="btn" onclick="toggleAnimation()">üé¨ Animacije</button>
        <button class="btn" onclick="resetDashboard()">üîÑ Reset</button>
        <button class="btn" onclick="connectWebSocket()">üîå Reconnect</button>
        <button class="btn" onclick="testPriorityFlows()">üéØ Test Prioritete</button>
    </div>

    <div id="info-box">
        <strong>üéØ OMNI-APP DASHBOARD</strong><br><br>
        Kliknite na modul za podrobnosti.<br><br>
        <strong>Funkcionalnosti:</strong><br>
        ‚Ä¢ Smart Auto-Layout<br>
        ‚Ä¢ Drag & Drop<br>
        ‚Ä¢ Real-time WebSocket<br>
        ‚Ä¢ Prioritetni tokovi<br>
        ‚Ä¢ Hierarhiƒçni moduli
    </div>

    <div id="controls">
        <div class="control-section">
            <h3>‚ûï Dodaj modul</h3>
            <input type="text" id="new-node-name" placeholder="Ime modula (npr. Tourism)"/>
            <input type="text" id="new-node-icon" placeholder="Emoji (npr. üèñÔ∏è)"/>
            <button onclick="addNode()">Dodaj modul</button>
        </div>

        <div class="control-section">
            <h3>üîó Dodaj podmodul</h3>
            <input type="text" id="parent-node-name" placeholder="Glavni modul"/>
            <input type="text" id="sub-node-name" placeholder="Ime podmodula"/>
            <input type="text" id="sub-node-icon" placeholder="Emoji"/>
            <button onclick="addSubNode()">Dodaj podmodul</button>
        </div>

        <div class="control-section">
            <h3>üóëÔ∏è Odstrani</h3>
            <input type="text" id="remove-node-name" placeholder="Ime modula/podmodula"/>
            <button onclick="removeNode()">Odstrani</button>
        </div>
    </div>

    <div class="stats-panel">
        <h3>üìä Statistike</h3>
        <div class="stat-item">
            <span>Moduli:</span>
            <span id="module-count">1</span>
        </div>
        <div class="stat-item">
            <span>Podmoduli:</span>
            <span id="submodule-count">0</span>
        </div>
        <div class="stat-item">
            <span>Aktivni tokovi:</span>
            <span id="active-flows">0</span>
        </div>
        <div class="stat-item">
            <span>WebSocket:</span>
            <span id="websocket-status">üî¥ Offline</span>
        </div>
    </div>

    <div class="priority-stats">
        <h3>üéØ Prioritetne statistike</h3>
        <div class="priority-item priority-high">
            <span>üî¥ Visoka prioriteta:</span>
            <span id="high-priority-count">0</span>
        </div>
        <div class="priority-item priority-medium">
            <span>üü† Srednja prioriteta:</span>
            <span id="medium-priority-count">0</span>
        </div>
        <div class="priority-item priority-low">
            <span>üü¢ Nizka prioriteta:</span>
            <span id="low-priority-count">0</span>
        </div>
    </div>

    <div class="shortcuts">
        <strong>Tipkovne bli≈ænjice:</strong><br>
        A - Dodaj modul | S - Dodaj submodul | L - Auto layout | R - Reset | T - Test prioritete
    </div>

    <script>
        // Globalne spremenljivke
        let nodes = [{id: "global", x: window.innerWidth/2, y: 100, type: "main", icon: "üåê", name: "Global Optimizer"}];
        let connections = [];
        let draggedNode = null;
        let animationEnabled = true;
        let websocket = null;
        let flowCounter = 0;

        // WebSocket povezava
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8080');
                
                websocket.onopen = function() {
                    console.log('‚úÖ WebSocket povezan');
                    document.getElementById('websocket-status').innerHTML = 'üü¢ Online';
                    updateNodeStatus('global', 'active');
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function() {
                    console.log('‚ùå WebSocket prekinjen');
                    document.getElementById('websocket-status').innerHTML = 'üî¥ Offline';
                    setTimeout(connectWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket napaka:', error);
                    document.getElementById('websocket-status').innerHTML = 'üü° Napaka';
                };
            } catch (error) {
                console.log('WebSocket ni na voljo, uporabljam simulacijo');
                simulateWebSocketData();
            }
        }

        // Simulacija WebSocket podatkov
        function simulateWebSocketData() {
            setInterval(() => {
                if (nodes.length > 1 && animationEnabled) {
                    const randomPriority = Math.floor(Math.random() * 3) + 1;
                    const randomSpeed = Math.floor(Math.random() * 5) + 1;
                    
                    const flowData = {
                        from: "global",
                        to: nodes[Math.floor(Math.random() * (nodes.length - 1)) + 1].id,
                        priority: randomPriority,
                        speed: randomSpeed,
                        active: true
                    };
                    
                    animateFlowPriority(flowData);
                }
            }, 1500);
        }

        // Obravnava WebSocket sporoƒçil
        function handleWebSocketMessage(data) {
            if (data.type === 'flow') {
                animateFlowPriority(data);
            } else if (data.type === 'status') {
                updateNodeStatus(data.nodeId, data.status);
            } else if (data.type === 'module_update') {
                updateModuleData(data);
            }
        }

        // Animacija prioritetnih tokov
        function animateFlowPriority(flowData) {
            if (!animationEnabled) return;
            
            const fromNode = nodes.find(n => n.id === flowData.from);
            const toNode = nodes.find(n => n.id === flowData.to);
            
            if (!fromNode || !toNode) return;
            
            // Doloƒçi barvo in velikost glede na prioriteto
            let color, size, glowEffect;
            switch(flowData.priority) {
                case 3: // Visoka prioriteta
                    color = '#e74c3c';
                    size = 8;
                    glowEffect = 'drop-shadow(0 0 8px #e74c3c)';
                    updatePriorityStats('high');
                    break;
                case 2: // Srednja prioriteta
                    color = '#f39c12';
                    size = 6;
                    glowEffect = 'none';
                    updatePriorityStats('medium');
                    break;
                case 1: // Nizka prioriteta
                default:
                    color = '#27ae60';
                    size = 4;
                    glowEffect = 'none';
                    updatePriorityStats('low');
                    break;
            }
            
            // Doloƒçi hitrost animacije (1-5, kjer 5 je najhitrej≈°e)
            const animationDuration = Math.max(1, 6 - flowData.speed) * 1000;
            
            const svg = document.getElementById('links');
            const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            
            dot.setAttribute('r', size);
            dot.setAttribute('fill', color);
            dot.style.filter = glowEffect;
            dot.setAttribute('cx', fromNode.x);
            dot.setAttribute('cy', fromNode.y);
            
            svg.appendChild(dot);
            
            // Animacija premikanja
            const startTime = Date.now();
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / animationDuration, 1);
                
                // Easing funkcija za gladko animacijo
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const x = fromNode.x + (toNode.x - fromNode.x) * easeProgress;
                const y = fromNode.y + (toNode.y - fromNode.y) * easeProgress;
                
                dot.setAttribute('cx', x);
                dot.setAttribute('cy', y);
                
                // Fade out efekt na koncu
                if (progress > 0.8) {
                    dot.style.opacity = (1 - progress) * 5;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    svg.removeChild(dot);
                    updateFlowStats();
                }
            };
            
            requestAnimationFrame(animate);
        }

        // Posodobi statistike prioritet
        function updatePriorityStats(priority) {
            const countElement = document.getElementById(`${priority}-priority-count`);
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = currentCount + 1;
        }

        // Posodobi statistike tokov
        function updateFlowStats() {
            flowCounter++;
            document.getElementById('active-flows').textContent = flowCounter;
        }

        // Dodaj nov modul
        function addNode() {
            const name = document.getElementById('new-node-name').value.trim();
            const icon = document.getElementById('new-node-icon').value.trim() || 'üì¶';
            
            if (!name) {
                alert('Vnesite ime modula!');
                return;
            }
            
            if (nodes.find(n => n.id === name.toLowerCase())) {
                alert('Modul s tem imenom ≈æe obstaja!');
                return;
            }
            
            const newNode = {
                id: name.toLowerCase(),
                name: name,
                icon: icon,
                x: Math.random() * (window.innerWidth - 200) + 100,
                y: Math.random() * (window.innerHeight - 200) + 150,
                type: 'main'
            };
            
            nodes.push(newNode);
            connections.push({from: 'global', to: newNode.id});
            
            createNodeElement(newNode);
            updateConnections();
            updateStats();
            
            // Poƒçisti input polja
            document.getElementById('new-node-name').value = '';
            document.getElementById('new-node-icon').value = '';
            
            console.log(`‚úÖ Dodan modul: ${name}`);
        }

        // Dodaj podmodul
        function addSubNode() {
            const parentName = document.getElementById('parent-node-name').value.trim().toLowerCase();
            const subName = document.getElementById('sub-node-name').value.trim();
            const subIcon = document.getElementById('sub-node-icon').value.trim() || 'üìã';
            
            if (!parentName || !subName) {
                alert('Vnesite ime glavnega modula in podmodula!');
                return;
            }
            
            const parentNode = nodes.find(n => n.id === parentName);
            if (!parentNode) {
                alert('Glavni modul ne obstaja!');
                return;
            }
            
            if (nodes.find(n => n.id === subName.toLowerCase())) {
                alert('Podmodul s tem imenom ≈æe obstaja!');
                return;
            }
            
            const subNode = {
                id: subName.toLowerCase(),
                name: subName,
                icon: subIcon,
                x: parentNode.x + 200,
                y: parentNode.y + 100,
                type: 'sub',
                parent: parentName
            };
            
            nodes.push(subNode);
            connections.push({from: parentName, to: subNode.id});
            
            createNodeElement(subNode);
            updateConnections();
            updateStats();
            
            // Poƒçisti input polja
            document.getElementById('parent-node-name').value = '';
            document.getElementById('sub-node-name').value = '';
            document.getElementById('sub-node-icon').value = '';
            
            console.log(`‚úÖ Dodan podmodul: ${subName} ‚Üí ${parentName}`);
        }

        // Odstrani modul
        function removeNode() {
            const nodeName = document.getElementById('remove-node-name').value.trim().toLowerCase();
            
            if (!nodeName) {
                alert('Vnesite ime modula za odstranitev!');
                return;
            }
            
            if (nodeName === 'global') {
                alert('Globalnega modula ne morete odstraniti!');
                return;
            }
            
            const nodeIndex = nodes.findIndex(n => n.id === nodeName);
            if (nodeIndex === -1) {
                alert('Modul ne obstaja!');
                return;
            }
            
            // Odstrani povezane podmodule
            const childNodes = nodes.filter(n => n.parent === nodeName);
            childNodes.forEach(child => {
                const childElement = document.getElementById(child.id);
                if (childElement) childElement.remove();
            });
            
            // Odstrani modul
            const nodeElement = document.getElementById(nodeName);
            if (nodeElement) nodeElement.remove();
            
            // Posodobi podatke
            nodes = nodes.filter(n => n.id !== nodeName && n.parent !== nodeName);
            connections = connections.filter(c => c.from !== nodeName && c.to !== nodeName);
            
            updateConnections();
            updateStats();
            
            document.getElementById('remove-node-name').value = '';
            console.log(`‚úÖ Odstranjen modul: ${nodeName}`);
        }

        // Ustvari DOM element za modul
        function createNodeElement(node) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `node ${node.type === 'sub' ? 'submodule' : ''}`;
            nodeDiv.id = node.id;
            nodeDiv.style.left = node.x + 'px';
            nodeDiv.style.top = node.y + 'px';
            
            nodeDiv.innerHTML = `
                <div class="node-title">${node.icon} ${node.name}</div>
                <span class="status loading" id="status-${node.id}">‚è≥ Inicializacija...</span>
            `;
            
            // Dodaj event listener-je
            attachNodeEvents(nodeDiv, node);
            
            document.getElementById('dashboard').appendChild(nodeDiv);
            
            // Simuliraj aktivacijo po kratkem ƒçasu
            setTimeout(() => {
                updateNodeStatus(node.id, 'active');
            }, Math.random() * 2000 + 1000);
        }

        // Dodaj event listener-je na modul
        function attachNodeEvents(element, node) {
            // Klik za info
            element.addEventListener('click', (e) => {
                if (!draggedNode) {
                    showNodeInfo(node);
                }
            });
            
            // Drag & Drop
            element.addEventListener('mousedown', (e) => {
                draggedNode = node;
                element.style.zIndex = '1000';
                
                const rect = element.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const offsetY = e.clientY - rect.top;
                
                const handleMouseMove = (e) => {
                    if (draggedNode) {
                        const x = e.clientX - offsetX;
                        const y = e.clientY - offsetY;
                        
                        element.style.left = x + 'px';
                        element.style.top = y + 'px';
                        
                        node.x = x;
                        node.y = y;
                        
                        updateConnections();
                    }
                };
                
                const handleMouseUp = () => {
                    draggedNode = null;
                    element.style.zIndex = '10';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        // Prika≈æi informacije o modulu
        function showNodeInfo(node) {
            const infoBox = document.getElementById('info-box');
            const connections_from = connections.filter(c => c.from === node.id).length;
            const connections_to = connections.filter(c => c.to === node.id).length;
            
            infoBox.innerHTML = `
                <strong>${node.icon} ${node.name}</strong><br><br>
                <strong>ID:</strong> ${node.id}<br>
                <strong>Tip:</strong> ${node.type === 'sub' ? 'Podmodul' : 'Glavni modul'}<br>
                ${node.parent ? `<strong>Nadrejeni:</strong> ${node.parent}<br>` : ''}
                <strong>Pozicija:</strong> ${Math.round(node.x)}, ${Math.round(node.y)}<br>
                <strong>Izhodni tokovi:</strong> ${connections_from}<br>
                <strong>Vhodni tokovi:</strong> ${connections_to}<br>
                <strong>Status:</strong> <span id="info-status-${node.id}">Nalaganje...</span>
            `;
            
            // Posodobi status v info box-u
            const statusElement = document.getElementById(`status-${node.id}`);
            const infoStatusElement = document.getElementById(`info-status-${node.id}`);
            if (statusElement && infoStatusElement) {
                infoStatusElement.textContent = statusElement.textContent;
                infoStatusElement.className = statusElement.className;
            }
        }

        // Posodobi status modula
        function updateNodeStatus(nodeId, status) {
            const statusElement = document.getElementById(`status-${nodeId}`);
            if (!statusElement) return;
            
            statusElement.className = `status ${status}`;
            
            switch(status) {
                case 'active':
                    statusElement.textContent = '‚úÖ Aktiven';
                    break;
                case 'loading':
                    statusElement.textContent = '‚è≥ Nalaganje...';
                    break;
                case 'error':
                    statusElement.textContent = '‚ùå Napaka';
                    break;
                case 'idle':
                    statusElement.textContent = 'üí§ Neaktiven';
                    break;
            }
        }

        // Posodobi povezave med moduli
        function updateConnections() {
            const svg = document.getElementById('links');
            
            // Odstrani stare povezave
            const oldLinks = svg.querySelectorAll('.link');
            oldLinks.forEach(link => link.remove());
            
            // Ustvari nove povezave
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (fromNode && toNode) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('class', 'link');
                    line.setAttribute('x1', fromNode.x + 90);
                    line.setAttribute('y1', fromNode.y + 40);
                    line.setAttribute('x2', toNode.x + 90);
                    line.setAttribute('y2', toNode.y + 40);
                    
                    svg.appendChild(line);
                }
            });
        }

        // Avtomatska razporeditev modulov
        function autoLayout() {
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const radius = 250;
            
            // Postavi Global modul v center
            const globalNode = nodes.find(n => n.id === 'global');
            if (globalNode) {
                globalNode.x = centerX - 90;
                globalNode.y = centerY - 40;
                
                const globalElement = document.getElementById('global');
                if (globalElement) {
                    globalElement.style.left = globalNode.x + 'px';
                    globalElement.style.top = globalNode.y + 'px';
                }
            }
            
            // Razporedi glavne module v krog
            const mainNodes = nodes.filter(n => n.type === 'main' && n.id !== 'global');
            mainNodes.forEach((node, index) => {
                const angle = (index * 2 * Math.PI) / mainNodes.length;
                node.x = centerX + Math.cos(angle) * radius - 90;
                node.y = centerY + Math.sin(angle) * radius - 40;
                
                const element = document.getElementById(node.id);
                if (element) {
                    element.style.left = node.x + 'px';
                    element.style.top = node.y + 'px';
                }
            });
            
            // Razporedi podmodule okoli njihovih nadrejenih
            const subNodes = nodes.filter(n => n.type === 'sub');
            subNodes.forEach((subNode, index) => {
                const parentNode = nodes.find(n => n.id === subNode.parent);
                if (parentNode) {
                    const subRadius = 120;
                    const parentSubs = subNodes.filter(n => n.parent === subNode.parent);
                    const subIndex = parentSubs.indexOf(subNode);
                    const angle = (subIndex * 2 * Math.PI) / parentSubs.length;
                    
                    subNode.x = parentNode.x + Math.cos(angle) * subRadius;
                    subNode.y = parentNode.y + Math.sin(angle) * subRadius;
                    
                    const element = document.getElementById(subNode.id);
                    if (element) {
                        element.style.left = subNode.x + 'px';
                        element.style.top = subNode.y + 'px';
                    }
                }
            });
            
            updateConnections();
            console.log('‚úÖ Auto layout izvr≈°en');
        }

        // Posodobi statistike
        function updateStats() {
            const mainModules = nodes.filter(n => n.type === 'main').length;
            const subModules = nodes.filter(n => n.type === 'sub').length;
            
            document.getElementById('module-count').textContent = mainModules;
            document.getElementById('submodule-count').textContent = subModules;
        }

        // Test funkcija za demonstracijo prioritetnih tokov
        function testPriorityFlows() {
            if (nodes.length < 2) {
                alert("Dodajte veƒç modulov za testiranje prioritetnih tokov!");
                return;
            }
            
            console.log("üéØ Testiram prioritetne tokove...");
            
            // Resetiraj statistike
            document.getElementById("high-priority-count").textContent = "0";
            document.getElementById("medium-priority-count").textContent = "0";
            document.getElementById("low-priority-count").textContent = "0";
            
            // Generiraj test tokove z razliƒçnimi prioritetami in hitrostmi
            const testFlows = [
                // Visoka prioriteta - hitri rdeƒçi tokovi
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 3, speed: 5, active: true},
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 3, speed: 4, active: true},
                
                // Srednja prioriteta - srednji oran≈æni tokovi
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 2, speed: 3, active: true},
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 2, speed: 2, active: true},
                
                // Nizka prioriteta - poƒçasni zeleni tokovi
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 1, speed: 1, active: true},
                {from: "global", to: nodes.find(n => n.id !== "global")?.id, priority: 1, speed: 2, active: true}
            ];
            
            // Za≈æeni test tokove z zamikom
            testFlows.forEach((flow, index) => {
                if (flow.to) {
                    setTimeout(() => {
                        animateFlowPriority(flow);
                    }, index * 500);
                }
            });
            
            // Prika≈æi obvestilo
            const infoBox = document.getElementById("info-box");
            infoBox.innerHTML = `
                <strong>üéØ PRIORITETNI TOKOVI TEST</strong><br><br>
                <span style="color: red;">üî¥ Rdeƒçi dot-i</span> = Visoka prioriteta (hitro)<br>
                <span style="color: orange;">üü† Oran≈æni dot-i</span> = Srednja prioriteta<br>
                <span style="color: green;">üü¢ Zeleni dot-i</span> = Nizka prioriteta (poƒçasi)<br><br>
                Opazujte razliƒçne hitrosti in velikosti dot-ov!<br>
                Statistike se posodabljajo v realnem ƒçasu.
            `;
        }

        // Preklopi animacije
        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            console.log(`üé¨ Animacije: ${animationEnabled ? 'vkljuƒçene' : 'izkljuƒçene'}`);
        }

        // Resetiraj dashboard
        function resetDashboard() {
            // Ohrani samo global modul
            nodes = [{id: "global", x: window.innerWidth/2 - 90, y: 100, type: "main", icon: "üåê", name: "Global Optimizer"}];
            connections = [];
            flowCounter = 0;
            
            // Odstrani vse module razen global
            const dashboard = document.getElementById('dashboard');
            const allNodes = dashboard.querySelectorAll('.node');
            allNodes.forEach(node => {
                if (node.id !== 'global') {
                    node.remove();
                }
            });
            
            // Poƒçisti povezave
            updateConnections();
            updateStats();
            
            // Resetiraj statistike prioritet
            document.getElementById("high-priority-count").textContent = "0";
            document.getElementById("medium-priority-count").textContent = "0";
            document.getElementById("low-priority-count").textContent = "0";
            document.getElementById("active-flows").textContent = "0";
            
            console.log('üîÑ Dashboard resetiran');
        }

        // Tipkovne bli≈ænjice
        document.addEventListener("keydown", (e) => {
            if (e.target.tagName === "INPUT") return;
            
            switch(e.key.toLowerCase()) {
                case 'a': 
                    document.getElementById("new-node-name").focus();
                    break;
                case 's': 
                    document.getElementById("parent-node-name").focus();
                    break;
                case 'l': 
                    autoLayout(); 
                    break;
                case 'r': 
                    resetDashboard(); 
                    break;
                case 't':
                    testPriorityFlows();
                    break;
            }
        });

        // Inicializacija ob nalaganju strani
        window.addEventListener('load', () => {
            console.log('üöÄ Omni-APP Dashboard inicializiran');
            
            // Ustvari DOM element za global modul
            createNodeElement(nodes[0]);
            updateConnections();
            updateStats();
            
            // Poskusi povezavo z WebSocket
            connectWebSocket();
            
            // Avtomatski layout po kratkem ƒçasu
            setTimeout(autoLayout, 1000);
        });

        // Responzivnost
        window.addEventListener('resize', () => {
            setTimeout(autoLayout, 500);
        });
    </script>
</body>
</html>