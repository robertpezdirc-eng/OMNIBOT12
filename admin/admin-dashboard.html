<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNI-BRAIN Admin Dashboard</title>
    
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="../responsive-dashboard.css">
    
    <!-- Bootstrap for compatibility -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Date-fns library removed - using native Date functions instead -->
    <style>
        .status-active { color: #28a745; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }
        .status-expired { color: #ffc107; font-weight: bold; }
        .last-check-recent { color: #28a745; }
        .last-check-old { color: #dc3545; }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .connected { background-color: #28a745; color: white; }
        .disconnected { background-color: #dc3545; color: white; }
        .loading { opacity: 0.6; pointer-events: none; }
        .table-container { max-height: 600px; overflow-y: auto; }
        .action-buttons { white-space: nowrap; }
        .module-badge { 
            font-size: 0.75em; 
            margin: 1px; 
            padding: 2px 6px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .create-license-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .filter-section {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .notification-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .role-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .role-super-admin { background: #dc3545; color: white; }
        .role-admin { background: #007bff; color: white; }
        .role-support { background: #28a745; color: white; }
        .role-moderator { background: #ffc107; color: black; }
        .search-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .demo-badge { background: #17a2b8; }
        .trial-badge { background: #6f42c1; }
        .enterprise-badge { background: #fd7e14; }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-circle"></i> Disconnected
    </div>

    <!-- User Role Indicator with Access Control -->
    <div id="userRole" class="position-fixed" style="top: 10px; left: 10px; z-index: 1000;">
        <span id="roleDisplay" class="role-badge role-admin">
            <i class="fas fa-user-shield"></i> Admin
        </span>
        <div class="dropdown mt-1">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="roleDropdown" data-bs-toggle="dropdown">
                Spremeni vlogo
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="changeUserRole('super-admin')">Super Admin</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeUserRole('admin')">Admin</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeUserRole('support')">Support</a></li>
                <li><a class="dropdown-item" href="#" onclick="changeUserRole('moderator')">Moderator</a></li>
            </ul>
        </div>
    </div>

    <!-- Access Control Debug Panel -->
    <div id="accessDebugPanel" class="position-fixed" style="top: 10px; right: 10px; z-index: 1000; max-width: 300px;">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <small><i class="fas fa-bug"></i> Access Debug Log</small>
            </div>
            <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                <div id="accessDebugLog" style="font-size: 0.8em; font-family: monospace;">
                    <div class="text-success">System initialized</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalLabel">
                        <i class="fas fa-lock"></i> OMNI-BRAIN Admin Prijava
                    </h5>
                </div>
                <div class="modal-body">
                    <div id="loginError" class="alert alert-danger d-none"></div>
                    
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">
                                <i class="fas fa-envelope"></i> Email
                            </label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">
                                <i class="fas fa-key"></i> Geslo
                            </label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        
                        <div id="twoFASection" class="mb-3 d-none">
                            <label for="twoFAToken" class="form-label">
                                <i class="fas fa-mobile-alt"></i> 2FA Token
                            </label>
                            <input type="text" class="form-control" id="twoFAToken" placeholder="6-mestna koda ali backup koda">
                            <small class="form-text text-muted">Vnesite kodo iz va≈°e avtentikacijske aplikacije</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                            <i class="fas fa-sign-in-alt"></i> Prijavi se
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Panel Modal -->
    <div class="modal fade" id="securityModal" tabindex="-1" aria-labelledby="securityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="securityModalLabel">
                        <i class="fas fa-shield-alt"></i> Varnostni Panel
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Uporabni≈°ke informacije</h6>
                            <div class="card">
                                <div class="card-body">
                                    <p><strong>Email:</strong> <span id="userEmail">-</span></p>
                                    <p><strong>Vloga:</strong> <span id="userRoleText">-</span></p>
                                    <p><strong>2FA:</strong> <span id="twoFAStatus">-</span></p>
                                    <p><strong>Zadnja prijava:</strong> <span id="lastLogin">-</span></p>
                                </div>
                            </div>
                            
                            <div id="enable2FASection" class="mt-3 d-none">
                                <h6><i class="fas fa-mobile-alt"></i> Omogoƒçi 2FA</h6>
                                <p class="text-muted">Dvo-faktorska avtentikacija poveƒça varnost va≈°ega raƒçuna.</p>
                                <button class="btn btn-warning" onclick="enable2FA()">
                                    <i class="fas fa-lock"></i> Omogoƒçi 2FA
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6><i class="fas fa-chart-bar"></i> Statistike prijav (zadnjih 30 dni)</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h4 id="successfulLogins">0</h4>
                                            <small>Uspe≈°ne</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h4 id="failedLogins">0</h4>
                                            <small>Neuspe≈°ne</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h4 id="uniqueUsers">0</h4>
                                            <small>Uporabniki</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-history"></i> Zadnje aktivnosti</h6>
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ƒåas</th>
                                    <th>Dogodek</th>
                                    <th>IP naslov</th>
                                </tr>
                            </thead>
                            <tbody id="auditLogTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">Nalagam...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Odjavi se
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zapri</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-3" id="dashboardContent" style="display: none;">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-4">
                            <i class="fas fa-shield-alt text-primary"></i>
                            Omni License Admin Dashboard
                        </h1>
                        <p class="text-muted">Upravljanje licenc v realnem ƒçasu</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-warning me-2" data-bs-toggle="modal" data-bs-target="#securityModal">
                            <i class="fas fa-shield-alt"></i> Varnost
                        </button>
                        <button class="btn btn-outline-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Odjava
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="totalLicenses">0</h3>
                    <p>Skupaj licenc</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="activeLicenses">0</h3>
                    <p>Aktivne licence</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="demoLicenses">0</h3>
                    <p>Demo licence</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="expiredLicenses">0</h3>
                    <p>Potekle licence</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="trialLicenses">0</h3>
                    <p>Trial licence</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card text-center">
                    <h3 id="recentChecks">0</h3>
                    <p>Nedavni preveri</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Distribucija licenc po statusu in planu</h5>
                        <small class="text-muted">Pregled vseh licenc po kategorijah</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="licenseDistributionChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Aktivne</small>
                                    <div class="fw-bold text-success" id="chartActiveCount">0</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Potekle</small>
                                    <div class="fw-bold text-danger" id="chartExpiredCount">0</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Demo</small>
                                    <div class="fw-bold text-warning" id="chartDemoCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Trend licenc (zadnjih 30 dni)</h5>
                        <small class="text-muted">Nove in potekle licence po dnevih</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="licenseTrendChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="row text-center">
                                <div class="col-6">
                                    <small class="text-muted">Nove danas</small>
                                    <div class="fw-bold text-primary" id="newTodayCount">0</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Potekle danas</small>
                                    <div class="fw-bold text-danger" id="expiredTodayCount">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Charts Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Licence po planih</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="planDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Potekanje licenc</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="expirationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-activity"></i> Aktivnost</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification System -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="notification-panel">
                    <h5><i class="fas fa-bullhorn"></i> Sistem obve≈°ƒçanja</h5>
                    <form id="notificationForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="notificationTarget" class="form-label">Ciljna skupina</label>
                            <select class="form-select" id="notificationTarget" required>
                                <option value="">Izberi skupino</option>
                                <option value="all">Vsi odjemalci</option>
                                <option value="active">Aktivni odjemalci</option>
                                <option value="expired">Potekle licence</option>
                                <option value="demo">Demo licence</option>
                                <option value="trial">Trial licence</option>
                                <option value="basic">Basic licence</option>
                                <option value="premium">Premium licence</option>
                                <option value="enterprise">Enterprise licence</option>
                                <option value="custom">Izbrani odjemalci</option>
                            </select>
                        </div>
                        <div class="col-md-3" id="customClientsDiv" style="display: none;">
                            <label for="customClients" class="form-label">Client ID-ji (loƒçeni z vejico)</label>
                            <input type="text" class="form-control" id="customClients" placeholder="client1,client2,client3">
                        </div>
                        <div class="col-md-2">
                            <label for="notificationPriority" class="form-label">Prioriteta</label>
                            <select class="form-select" id="notificationPriority">
                                <option value="info">Info</option>
                                <option value="warning">Opozorilo</option>
                                <option value="error">Napaka</option>
                                <option value="success">Uspeh</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="notificationMessage" class="form-label">Sporoƒçilo</label>
                            <input type="text" class="form-control" id="notificationMessage" placeholder="Vnesite sporoƒçilo" required>
                        </div>
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-paper-plane"></i> Po≈°lji obvestilo
                                </button>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="debugNotifications" checked>
                                    <label class="form-check-label" for="debugNotifications">
                                        Debug logging
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Notification Log -->
                    <div class="mt-3">
                        <h6><i class="fas fa-history"></i> Zadnja obvestila</h6>
                        <div id="notificationLog" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background: #f8f9fa;">
                            <small class="text-muted">Ni poslanih obvestil</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Napredni filtri in iskanje</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Poƒçisti filtre
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="searchInput" class="form-label">Iskanje po Client ID ali podjetju</label>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Vnesite Client ID ali ime podjetja..." 
                                       oninput="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <label for="statusFilter" class="form-label">Status licence</label>
                                <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                    <option value="">Vsi statusi</option>
                                    <option value="active">Aktivne</option>
                                    <option value="inactive">Neaktivne</option>
                                    <option value="expired">Potekle</option>
                                    <option value="demo">Demo</option>
                                    <option value="trial">Trial</option>
                                    <option value="suspended">Suspendirane</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="planFilter" class="form-label">Plan</label>
                                <select class="form-select" id="planFilter" onchange="applyFilters()">
                                    <option value="">Vsi plani</option>
                                    <option value="basic">Basic</option>
                                    <option value="premium">Premium</option>
                                    <option value="enterprise">Enterprise</option>
                                    <option value="demo">Demo</option>
                                    <option value="trial">Trial</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="moduleFilter" class="form-label">Modul</label>
                                <select class="form-select" id="moduleFilter" onchange="applyFilters()">
                                    <option value="">Vsi moduli</option>
                                    <option value="tourism">Turizem</option>
                                    <option value="finance">Finance</option>
                                    <option value="iot">IoT</option>
                                    <option value="analytics">Analitika</option>
                                    <option value="ai">AI Asistent</option>
                                    <option value="automation">Avtomatizacija</option>
                                    <option value="reporting">Poroƒçila</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="expiryFilter" class="form-label">Datum poteka</label>
                                <select class="form-select" id="expiryFilter" onchange="applyFilters()">
                                    <option value="">Vsi datumi</option>
                                    <option value="expired">≈Ωe potekle</option>
                                    <option value="week">Potekajo v 7 dneh</option>
                                    <option value="month">Potekajo v 30 dneh</option>
                                    <option value="valid">Veljavne > 30 dni</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">Rezultati</label>
                                <select class="form-select" id="pageSizeFilter" onchange="applyFilters()">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label for="dateFromFilter" class="form-label">Datum od</label>
                                <input type="date" class="form-control" id="dateFromFilter" onchange="applyFilters()">
                            </div>
                            <div class="col-md-3">
                                <label for="dateToFilter" class="form-label">Datum do</label>
                                <input type="date" class="form-control" id="dateToFilter" onchange="applyFilters()">
                            </div>
                            <div class="col-md-3">
                                <label for="companyFilter" class="form-label">Podjetje</label>
                                <input type="text" class="form-control" id="companyFilter" 
                                       placeholder="Ime podjetja..." 
                                       oninput="applyFilters()">
                            </div>
                            <div class="col-md-3">
                                <label for="emailFilter" class="form-label">E-po≈°ta</label>
                                <input type="email" class="form-control" id="emailFilter" 
                                       placeholder="Kontaktna e-po≈°ta..." 
                                       oninput="applyFilters()">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge bg-info me-2" id="filterResultCount">0 rezultatov</span>
                                        <span class="text-muted" id="filterStatus">Ni aktivnih filtrov</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="saveFilterPreset()">
                                            <i class="fas fa-save"></i> Shrani filter
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="exportFilteredResults()">
                                            <i class="fas fa-download"></i> Izvozi filtrirane
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create License Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="create-license-form">
                    <h4><i class="fas fa-plus-circle text-success"></i> Ustvari novo licenco</h4>
                    <form id="createLicenseForm" class="row g-3">
                        <div class="col-md-3">
                            <label for="clientId" class="form-label">Client ID</label>
                            <input type="text" class="form-control" id="clientId" required>
                        </div>
                        <div class="col-md-2">
                            <label for="plan" class="form-label">Plan</label>
                            <select class="form-select" id="plan" required>
                                <option value="">Izberi plan</option>
                                <option value="basic">Basic</option>
                                <option value="premium">Premium</option>
                                <option value="enterprise">Enterprise</option>
                                <option value="demo">Demo</option>
                                <option value="trial">Trial</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="modules" class="form-label">Moduli</label>
                            <input type="text" class="form-control" id="modules" placeholder="tourism,finance,iot" required>
                        </div>
                        <div class="col-md-2">
                            <label for="expiresAt" class="form-label">Poteƒçe</label>
                            <input type="date" class="form-control" id="expiresAt" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-plus"></i> Ustvari
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- License Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-table"></i> Tabela licenc</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshLicenses()">
                                <i class="fas fa-sync-alt"></i> Osve≈æi
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="exportLicenses()">
                                <i class="fas fa-download"></i> Izvozi
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container">
                            <table class="table table-striped table-hover mb-0" id="licensesTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Client ID</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Moduli</th>
                                        <th>Poteƒçe</th>
                                        <th>Zadnji preveri</th>
                                        <th>Akcije</th>
                                    </tr>
                                </thead>
                                <tbody id="licensesTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Nalagam...</span>
                                            </div>
                                            <p class="mt-2">Nalagam licence...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend License Modal -->
    <div class="modal fade" id="extendLicenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Podalj≈°aj licenco</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="extendLicenseForm">
                        <input type="hidden" id="extendLicenseId">
                        <div class="mb-3">
                            <label for="extendClientId" class="form-label">Client ID</label>
                            <input type="text" class="form-control" id="extendClientId" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="newExpiresAt" class="form-label">Nov datum poteka</label>
                            <input type="date" class="form-control" id="newExpiresAt" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Prekliƒçi</button>
                    <button type="button" class="btn btn-primary" onclick="confirmExtendLicense()">Podalj≈°aj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const SERVER_URL = 'http://localhost:3001';
        const ADMIN_URL = window.location.origin;
        
        // Global variables
        let socket = null;
        let licenses = [];
        let filteredLicenses = [];
        let isConnected = false;
        let currentUserRole = 'admin'; // super-admin, admin, support, moderator
        let licenseDistributionChart = null;
        let licenseTrendChart = null;
        let heartbeatInterval = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            setupEventListeners();
            initializeCharts();
            refreshLicenses();
            
            // Set default expiration date to 1 year from now
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            document.getElementById('expiresAt').value = nextYear.toISOString().split('T')[0];
        });

        // WebSocket initialization and management
        function initializeWebSocket() {
            try {
                socket = io(SERVER_URL, {
                    rejectUnauthorized: false,
                    transports: ['websocket', 'polling'],
                    timeout: 20000,
                    forceNew: true
                });

                socket.on('connect', function() {
                    console.log('‚úÖ WebSocket connected to', SERVER_URL);
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                    showToast('Povezava vzpostavljena', 'success');
                    startHeartbeat();
                });

                socket.on('disconnect', function() {
                    console.log('‚ùå WebSocket disconnected');
                    isConnected = false;
                    updateConnectionStatus(false);
                    showToast('Povezava prekinjena', 'warning');
                    stopHeartbeat();
                    attemptReconnect();
                });

                socket.on('license_update', function(license) {
                    console.log('üì° License update received:', license);
                    handleLicenseUpdate(license);
                    showToast(`Licenca ${license.client_id} posodobljena`, 'info');
                });

                socket.on('system_notification', function(notification) {
                    console.log('üì¢ System notification:', notification);
                    showToast(notification.message, notification.type || 'info');
                });

                socket.on('connect_error', function(error) {
                    console.error('‚ùå WebSocket connection error:', error);
                    updateConnectionStatus(false);
                    attemptReconnect();
                });

                socket.on('pong', function() {
                    console.log('üèì Pong received');
                });

            } catch (error) {
                console.error('‚ùå WebSocket initialization error:', error);
                updateConnectionStatus(false);
                attemptReconnect();
            }
        }

        // Heartbeat mechanism
        function startHeartbeat() {
            heartbeatInterval = setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('ping');
                }
            }, 30000); // 30 seconds
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Automatic reconnection
        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`üîÑ Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts}`);
                
                setTimeout(() => {
                    if (!isConnected) {
                        initializeWebSocket();
                    }
                }, Math.pow(2, reconnectAttempts) * 1000); // Exponential backoff
            } else {
                console.error('‚ùå Max reconnection attempts reached');
                showToast('Povezava ni mogoƒça. Osve≈æite stran.', 'danger');
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
            }
        }

        // Handle real-time license updates
        function handleLicenseUpdate(updatedLicense) {
            const index = licenses.findIndex(l => l._id === updatedLicense._id);
            if (index !== -1) {
                licenses[index] = updatedLicense;
            } else {
                licenses.push(updatedLicense);
            }
            applyFilters();
            updateStatistics();
            updateCharts();
        }

        // Initialize charts
        function initializeCharts() {
            // License Distribution Chart
            const distributionCtx = document.getElementById('licenseDistributionChart').getContext('2d');
            licenseDistributionChart = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Aktivne', 'Demo', 'Trial', 'Potekle', 'Neaktivne'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#28a745',
                            '#17a2b8',
                            '#6f42c1',
                            '#ffc107',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // License Trend Chart
            const trendCtx = document.getElementById('licenseTrendChart').getContext('2d');
            licenseTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Aktivne licence',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Demo licence',
                        data: [],
                        borderColor: '#17a2b8',
                        backgroundColor: 'rgba(23, 162, 184, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            if (!licenseDistributionChart || !licenseTrendChart) return;

            const active = licenses.filter(l => l.active && !isExpired(l)).length;
            const demo = licenses.filter(l => l.plan === 'demo').length;
            const trial = licenses.filter(l => l.plan === 'trial').length;
            const expired = licenses.filter(l => isExpired(l)).length;
            const inactive = licenses.filter(l => !l.active && !isExpired(l)).length;

            licenseDistributionChart.data.datasets[0].data = [active, demo, trial, expired, inactive];
            licenseDistributionChart.update();

            // Generate trend data for last 30 days
            const trendData = generateTrendData();
            licenseTrendChart.data.labels = trendData.labels;
            licenseTrendChart.data.datasets[0].data = trendData.active;
            licenseTrendChart.data.datasets[1].data = trendData.demo;
            licenseTrendChart.update();
        }

        // Generate trend data
        function generateTrendData() {
            const labels = [];
            const activeData = [];
            const demoData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('sl-SI', { month: 'short', day: 'numeric' }));
                
                // Simulate trend data (in real implementation, this would come from server)
                const baseActive = licenses.filter(l => l.active && !isExpired(l)).length;
                const baseDemo = licenses.filter(l => l.plan === 'demo').length;
                
                activeData.push(Math.max(0, baseActive + Math.floor(Math.random() * 10) - 5));
                demoData.push(Math.max(0, baseDemo + Math.floor(Math.random() * 5) - 2));
            }
            
            return { labels, active: activeData, demo: demoData };
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('createLicenseForm').addEventListener('submit', handleCreateLicense);
            document.getElementById('notificationForm').addEventListener('submit', handleSendNotification);
            
            // Filter event listeners
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('planFilter').addEventListener('change', applyFilters);
            document.getElementById('moduleFilter').addEventListener('change', applyFilters);
            document.getElementById('expiryFilter').addEventListener('change', applyFilters);
            
            // Notification target change
            document.getElementById('notificationTarget').addEventListener('change', function() {
                const customDiv = document.getElementById('customClientsDiv');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                }
            });
        }

        // Refresh licenses from server
        async function refreshLicenses() {
            try {
                const response = await axios.get(`${SERVER_URL}/api/license/all`, {
                    timeout: 5000
                });
                
                licenses = Array.isArray(response.data) ? response.data : 
                          response.data.licenses ? response.data.licenses : 
                          response.data.data ? response.data.data : [];
                
                applyFilters();
                updateStatistics();
                updateCharts();
                
            } catch (error) {
                console.error('‚ùå Error fetching licenses:', error);
                showToast('Napaka pri nalaganju licenc', 'danger');
                
                // Show empty state
                document.getElementById('licensesTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                            <p class="mt-2">Napaka pri nalaganju licenc</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshLicenses()">
                                <i class="fas fa-retry"></i> Poskusi znova
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // Apply filters and search
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const planFilter = document.getElementById('planFilter').value;
            const moduleFilter = document.getElementById('moduleFilter').value;
            const expiryFilter = document.getElementById('expiryFilter').value;

            filteredLicenses = licenses.filter(license => {
                // Search filter
                const searchMatch = !searchTerm || 
                    license.client_id.toLowerCase().includes(searchTerm) ||
                    (license.plan && license.plan.toLowerCase().includes(searchTerm)) ||
                    (Array.isArray(license.modules) && license.modules.some(m => m.toLowerCase().includes(searchTerm)));

                // Status filter
                const status = getLicenseStatus(license).toLowerCase();
                const statusMatch = !statusFilter || 
                    (statusFilter === 'active' && status === 'aktivna') ||
                    (statusFilter === 'inactive' && status === 'neaktivna') ||
                    (statusFilter === 'expired' && status === 'potekla');

                // Plan filter
                const planMatch = !planFilter || license.plan === planFilter;

                // Module filter
                const moduleMatch = !moduleFilter || 
                    (Array.isArray(license.modules) && license.modules.includes(moduleFilter));

                // Expiry filter
                let expiryMatch = true;
                if (expiryFilter) {
                    const now = new Date();
                    const expiryDate = new Date(license.expires_at);
                    
                    if (expiryFilter === 'week') {
                        const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        expiryMatch = expiryDate <= weekFromNow && expiryDate > now;
                    } else if (expiryFilter === 'month') {
                        const monthFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                        expiryMatch = expiryDate <= monthFromNow && expiryDate > now;
                    } else if (expiryFilter === 'expired') {
                        expiryMatch = expiryDate < now;
                    }
                }

                return searchMatch && statusMatch && planMatch && moduleMatch && expiryMatch;
            });

            renderLicensesTable();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('planFilter').value = '';
            document.getElementById('moduleFilter').value = '';
            document.getElementById('expiryFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('companyFilter').value = '';
            document.getElementById('emailFilter').value = '';
            
            currentFilters = {};
            filteredLicenses = licenses || [];
            updateFilterStatus();
            displayLicenses(filteredLicenses);
            updateCharts();
        }

        function updateFilterStatus() {
            const resultCount = document.getElementById('filterResultCount');
            const filterStatus = document.getElementById('filterStatus');
            
            resultCount.textContent = `${filteredLicenses.length} rezultatov`;
            
            const activeFilters = Object.values(currentFilters).filter(value => value && value.trim() !== '').length;
            if (activeFilters > 0) {
                filterStatus.textContent = `${activeFilters} aktivnih filtrov`;
                filterStatus.className = 'text-primary';
            } else {
                filterStatus.textContent = 'Ni aktivnih filtrov';
                filterStatus.className = 'text-muted';
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('planFilter').value = '';
            document.getElementById('moduleFilter').value = '';
            document.getElementById('expiryFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            document.getElementById('companyFilter').value = '';
            document.getElementById('emailFilter').value = '';
            
            currentFilters = {};
            filteredLicenses = licenses || [];
            updateFilterStatus();
            displayLicenses(filteredLicenses);
            updateCharts();
        }

        function exportFilteredResults() {
            if (!filteredLicenses || filteredLicenses.length === 0) {
                showToast('Ni podatkov za izvoz', 'warning');
                return;
            }

            const csvContent = generateCSV(filteredLicenses);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `filtrirane_licence_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Filtrirani podatki izvo≈æeni', 'success');
        }

        function saveFilterPreset() {
            const presetName = prompt('Vnesite ime za shranjevanje filtra:');
            if (presetName && presetName.trim()) {
                const presets = JSON.parse(localStorage.getItem('licenseFilterPresets') || '{}');
                presets[presetName.trim()] = currentFilters;
                localStorage.setItem('licenseFilterPresets', JSON.stringify(presets));
                showToast(`Filter "${presetName}" shranjen`, 'success');
            }
        }

        // Render licenses table
        function renderLicensesTable() {
            const tbody = document.getElementById('licensesTableBody');
            
            if (!filteredLicenses || filteredLicenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-search text-muted fa-2x"></i>
                            <p class="mt-2">Ni najdenih licenc</p>
                            ${licenses.length > 0 ? '<button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()"><i class="fas fa-times"></i> Poƒçisti filtre</button>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredLicenses.map(license => {
                const status = getLicenseStatus(license);
                const statusClass = getStatusClass(status);
                const lastCheckClass = getLastCheckClass(license.last_check);
                const modules = Array.isArray(license.modules) ? license.modules : [];
                
                return `
                    <tr>
                        <td><strong>${license.client_id}</strong></td>
                        <td><span class="badge bg-secondary">${license.plan || 'N/A'}</span></td>
                        <td><span class="${statusClass}">${status}</span></td>
                        <td>
                            ${modules.map(module => 
                                `<span class="badge bg-info module-badge">${module}</span>`
                            ).join('')}
                        </td>
                        <td>${formatDate(license.expires_at)}</td>
                        <td class="${lastCheckClass}">${formatLastCheck(license.last_check)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm ${license.active ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleLicense('${license._id}')" 
                                    title="${license.active ? 'Deaktiviraj' : 'Aktiviraj'}">
                                <i class="fas ${license.active ? 'fa-pause' : 'fa-play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" 
                                    onclick="showExtendModal('${license._id}', '${license.client_id}')" 
                                    title="Podalj≈°aj">
                                <i class="fas fa-calendar-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="deleteLicense('${license._id}')" 
                                    title="Izbri≈°i">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Send notification to clients with enhanced debug logging
        async function sendNotification() {
            const target = document.getElementById('notificationTarget').value;
            const message = document.getElementById('notificationMessage').value.trim();
            const priority = document.getElementById('notificationPriority').value;
            const customClients = document.getElementById('customClients').value.trim();
            const debugEnabled = document.getElementById('debugNotifications').checked;

            if (!target || !message) {
                showToast('Ciljna skupina in sporoƒçilo sta obvezna', 'warning');
                return;
            }

            if (target === 'custom' && !customClients) {
                showToast('Client ID-ji so obvezni za izbrane odjemalce', 'warning');
                return;
            }

            try {
                // Debug logging
                if (debugEnabled) {
                    console.log('üîî Po≈°iljanje obvestila:', {
                        target,
                        message,
                        priority,
                        customClients: target === 'custom' ? customClients.split(',').map(id => id.trim()) : null,
                        timestamp: new Date().toISOString()
                    });
                }

                // Determine target clients based on selection
                let targetClients = [];
                if (target === 'custom') {
                    targetClients = customClients.split(',').map(id => id.trim()).filter(id => id);
                } else {
                    // Filter licenses based on target
                    targetClients = licenses
                        .filter(license => {
                            switch (target) {
                                case 'all': return true;
                                case 'active': return license.active && new Date(license.expires_at) > new Date();
                                case 'expired': return new Date(license.expires_at) <= new Date();
                                case 'demo': return license.plan === 'demo';
                                case 'trial': return license.plan === 'trial';
                                case 'basic': return license.plan === 'basic';
                                case 'premium': return license.plan === 'premium';
                                case 'enterprise': return license.plan === 'enterprise';
                                default: return false;
                            }
                        })
                        .map(license => license.client_id);
                }

                const payload = {
                    message: message,
                    priority: priority,
                    target: target,
                    client_ids: targetClients,
                    timestamp: new Date().toISOString()
                };

                const response = await axios.post(`${SERVER_URL}/api/notifications/send`, payload, {
                    timeout: 10000
                });

                // Log successful notification
                logNotification({
                    type: 'success',
                    target,
                    message,
                    priority,
                    clientCount: targetClients.length,
                    timestamp: new Date().toISOString()
                });

                if (debugEnabled) {
                    console.log('‚úÖ Obvestilo uspe≈°no poslano:', {
                        clientCount: targetClients.length,
                        response: response.data
                    });
                }

                showToast(`Obvestilo poslano ${targetClients.length} odjemalcem`, 'success');
                
                // Clear form
                document.getElementById('notificationMessage').value = '';
                document.getElementById('customClients').value = '';
                document.getElementById('notificationTarget').value = '';
                document.getElementById('customClientsDiv').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Napaka pri po≈°iljanju obvestila:', error);
                
                // Log failed notification
                logNotification({
                    type: 'error',
                    target,
                    message,
                    priority,
                    error: error.message,
                    timestamp: new Date().toISOString()
                });

                if (debugEnabled) {
                    console.error('‚ùå Debug - Podrobnosti napake:', {
                        status: error.response?.status,
                        statusText: error.response?.statusText,
                        data: error.response?.data
                    });
                }

                showToast('Napaka pri po≈°iljanju obvestila: ' + (error.response?.data?.message || error.message), 'danger');
            }
        }

        // Log notification to the notification log panel
        function logNotification(logEntry) {
            const logContainer = document.getElementById('notificationLog');
            const logElement = document.createElement('div');
            logElement.className = `small mb-1 p-2 rounded ${logEntry.type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'}`;
            
            const time = new Date(logEntry.timestamp).toLocaleTimeString('sl-SI');
            const icon = logEntry.type === 'success' ? '‚úÖ' : '‚ùå';
            
            logElement.innerHTML = `
                <strong>${icon} ${time}</strong> - ${logEntry.target} 
                ${logEntry.type === 'success' ? `(${logEntry.clientCount} odjemalcev)` : '(napaka)'}
                <br><small>"${logEntry.message}"</small>
                ${logEntry.error ? `<br><small class="text-warning">Napaka: ${logEntry.error}</small>` : ''}
            `;
            
            // Add to top of log
            if (logContainer.firstChild && logContainer.firstChild.tagName !== 'SMALL') {
                logContainer.insertBefore(logElement, logContainer.firstChild);
            } else {
                logContainer.innerHTML = '';
                logContainer.appendChild(logElement);
            }
            
            // Keep only last 10 entries
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Send notification to clients
        async function sendNotification() {
            // Check permission first
            if (!checkPermission('send_notification')) {
                showToast('Nimate dovoljenja za po≈°iljanje obvestil', 'danger');
                return;
            }

            const target = document.getElementById('notificationTarget').value;
            const message = document.getElementById('notificationMessage').value.trim();
            const clientIds = document.getElementById('clientIds').value.trim();

            if (!message) {
                showToast('Sporoƒçilo je obvezno', 'warning');
                logAccessAction('send_notification', false, 'Empty message');
                return;
            }

            if (target === 'specific' && !clientIds) {
                showToast('ID-ji strank so obvezni za specifiƒçno obve≈°ƒçanje', 'warning');
                logAccessAction('send_notification', false, 'Missing client IDs for specific target');
                return;
            }

            try {
                const payload = {
                    message: message,
                    target: target,
                    sender: currentUserRole,
                    timestamp: new Date().toISOString()
                };

                if (target === 'specific') {
                    payload.client_ids = clientIds.split(',').map(id => id.trim()).filter(id => id);
                }

                logAccessAction('send_notification', true, `Sending to ${target}, message length: ${message.length}`);

                const response = await axios.post(`${SERVER_URL}/api/notifications/send`, payload, {
                    timeout: 10000
                });

                showToast('Obvestilo uspe≈°no poslano', 'success');
                logAccessAction('send_notification', true, `Successfully sent to ${target}`);
                
                // Clear form
                document.getElementById('notificationForm').reset();
                document.getElementById('clientIdsGroup').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error sending notification:', error);
                showToast('Napaka pri po≈°iljanju obvestila', 'danger');
                logAccessAction('send_notification', false, `Error: ${error.message}`);
            }
        }

        // Initialize charts
        function initializeCharts() {
            // License Distribution Chart
            const distributionCtx = document.getElementById('licenseDistributionChart').getContext('2d');
            licenseDistributionChart = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Aktivne', 'Potekle', 'Demo', 'Trial', 'Basic', 'Premium', 'Enterprise'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#28a745',  // Aktivne - zelena
                            '#dc3545',  // Potekle - rdeƒça
                            '#ffc107',  // Demo - rumena
                            '#17a2b8',  // Trial - cyan
                            '#6f42c1',  // Basic - vijoliƒçna
                            '#fd7e14',  // Premium - oran≈æna
                            '#20c997'   // Enterprise - teal
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 5,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });

            // License Trend Chart
            const trendCtx = document.getElementById('licenseTrendChart').getContext('2d');
            licenseTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nove licence',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#007bff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }, {
                        label: 'Potekle licence',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#dc3545',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#007bff',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // Update charts with current data
        function updateCharts() {
            if (!licenses || licenses.length === 0) {
                // Reset charts to empty state
                licenseDistributionChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0, 0];
                licenseDistributionChart.update();
                
                licenseTrendChart.data.labels = [];
                licenseTrendChart.data.datasets[0].data = [];
                licenseTrendChart.data.datasets[1].data = [];
                licenseTrendChart.update();
                return;
            }

            // Update distribution chart with enhanced categorization
            const active = licenses.filter(l => l.is_active && !isLicenseExpired(l)).length;
            const expired = licenses.filter(l => isLicenseExpired(l)).length;
            const demo = licenses.filter(l => (l.plan === 'demo' || l.plan === 'Demo') && !isLicenseExpired(l)).length;
            const trial = licenses.filter(l => (l.plan === 'trial' || l.plan === 'Trial') && !isLicenseExpired(l)).length;
            const basic = licenses.filter(l => (l.plan === 'basic' || l.plan === 'Basic') && !isLicenseExpired(l)).length;
            const premium = licenses.filter(l => (l.plan === 'premium' || l.plan === 'Premium') && !isLicenseExpired(l)).length;
            const enterprise = licenses.filter(l => (l.plan === 'enterprise' || l.plan === 'Enterprise') && !isLicenseExpired(l)).length;

            licenseDistributionChart.data.datasets[0].data = [active, expired, demo, trial, basic, premium, enterprise];
            licenseDistributionChart.update('active');

            // Update trend chart with enhanced data
            const trendData = generateEnhancedTrendData();
            licenseTrendChart.data.labels = trendData.labels;
            licenseTrendChart.data.datasets[0].data = trendData.newLicenses;
            licenseTrendChart.data.datasets[1].data = trendData.expiredLicenses;
            licenseTrendChart.update('active');
        }

        // Generate enhanced trend data for the last 30 days
        function generateEnhancedTrendData() {
            const days = 30;
            const labels = [];
            const newLicenses = [];
            const expiredLicenses = [];
            const now = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('sl-SI', { month: 'short', day: 'numeric' }));
                
                // Count licenses created on this day
                const newCount = licenses.filter(license => {
                    if (!license.created_at) return false;
                    const createdDate = new Date(license.created_at).toISOString().split('T')[0];
                    return createdDate === dateStr;
                }).length;
                
                // Count licenses that expired on this day
                const expiredCount = licenses.filter(license => {
                    if (!license.expires_at) return false;
                    const expiredDate = new Date(license.expires_at).toISOString().split('T')[0];
                    return expiredDate === dateStr;
                }).length;
                
                newLicenses.push(newCount);
                expiredLicenses.push(expiredCount);
            }

            return { labels, newLicenses, expiredLicenses };
        }

        // Update statistics
        function updateStatistics() {
            if (!licenses || licenses.length === 0) {
                document.getElementById('totalLicenses').textContent = '0';
                document.getElementById('activeLicenses').textContent = '0';
                document.getElementById('expiredLicenses').textContent = '0';
                document.getElementById('demoLicenses').textContent = '0';
                return;
            }

            const total = licenses.length;
            const active = licenses.filter(l => l.is_active && !isLicenseExpired(l)).length;
            const expired = licenses.filter(l => isLicenseExpired(l)).length;
            const demo = licenses.filter(l => l.plan === 'demo' || l.plan === 'Demo').length;

            document.getElementById('totalLicenses').textContent = total;
            document.getElementById('activeLicenses').textContent = active;
            document.getElementById('expiredLicenses').textContent = expired;
            document.getElementById('demoLicenses').textContent = demo;
        }

        // Handle create license form submission
        async function handleCreateLicense(event) {
            event.preventDefault();
            
            // Check permission first
            if (!checkPermission('create_license')) {
                showToast('Nimate dovoljenja za ustvarjanje licenc', 'danger');
                return;
            }
            
            const formData = {
                client_id: document.getElementById('clientId').value,
                plan: document.getElementById('plan').value,
                modules: document.getElementById('modules').value.split(',').map(m => m.trim()),
                expires_at: document.getElementById('expiresAt').value,
                active: true,
                created_by: currentUserRole
            };

            try {
                logAccessAction('create_license', true, `Creating license for ${formData.client_id}, plan: ${formData.plan}`);
                
                const response = await axios.post(`${SERVER_URL}/api/license/create`, formData);
                showToast(`Licenca ${formData.client_id} ustvarjena`, 'success');
                logAccessAction('create_license', true, `Successfully created license for ${formData.client_id}`);
                
                document.getElementById('createLicenseForm').reset();
                
                // Set default expiration date again
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                document.getElementById('expiresAt').value = nextYear.toISOString().split('T')[0];
                
            } catch (error) {
                console.error('‚ùå Error creating license:', error);
                showToast('Napaka pri ustvarjanju licence', 'danger');
                logAccessAction('create_license', false, `Error creating license: ${error.message}`);
            }
        }

        // Toggle license status
        async function toggleLicense(licenseId) {
            // Check permission first
            if (!checkPermission('modify_license')) {
                showToast('Nimate dovoljenja za spreminjanje licenc', 'danger');
                return;
            }
            
            try {
                logAccessAction('modify_license', true, `Toggling license ${licenseId}`);
                
                const response = await axios.post(`${SERVER_URL}/api/license/toggle/${licenseId}`);
                const license = response.data;
                showToast(`Licenca ${license.client_id} ${license.active ? 'aktivirana' : 'deaktivirana'}`, 'success');
                logAccessAction('modify_license', true, `Successfully toggled license ${licenseId} to ${license.active ? 'active' : 'inactive'}`);
            } catch (error) {
                console.error('‚ùå Error toggling license:', error);
                showToast('Napaka pri preklapljanju licence', 'danger');
                logAccessAction('modify_license', false, `Error toggling license ${licenseId}: ${error.message}`);
            }
        }

        // Show extend license modal
        function showExtendModal(licenseId, clientId) {
            document.getElementById('extendLicenseId').value = licenseId;
            document.getElementById('extendClientId').value = clientId;
            
            // Set default new expiration to 1 year from now
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            document.getElementById('newExpiresAt').value = nextYear.toISOString().split('T')[0];
            
            new bootstrap.Modal(document.getElementById('extendLicenseModal')).show();
        }

        // Confirm extend license
        async function confirmExtendLicense() {
            const licenseId = document.getElementById('extendLicenseId').value;
            const newExpiresAt = document.getElementById('newExpiresAt').value;

            try {
                const response = await axios.post(`${SERVER_URL}/api/license/extend/${licenseId}`, {
                    expires_at: newExpiresAt
                });
                
                showToast('Licenca podalj≈°ana', 'success');
                bootstrap.Modal.getInstance(document.getElementById('extendLicenseModal')).hide();
                
            } catch (error) {
                console.error('‚ùå Error extending license:', error);
                showToast('Napaka pri podalj≈°anju licence', 'danger');
            }
        }

        // Delete license
        async function deleteLicense(licenseId) {
            if (!confirm('Ali ste prepriƒçani, da ≈æelite izbrisati to licenco?')) {
                return;
            }

            try {
                await axios.delete(`${SERVER_URL}/api/license/${licenseId}`);
                showToast('Licenca izbrisana', 'success');
            } catch (error) {
                console.error('‚ùå Error deleting license:', error);
                showToast('Napaka pri brisanju licence', 'danger');
            }
        }

        // Export licenses
        function exportLicenses() {
            const csv = convertToCSV(licenses);
            downloadCSV(csv, 'licenses.csv');
            showToast('Licence izvo≈æene', 'success');
        }

        // Utility functions
        function getLicenseStatus(license) {
            if (!license.active) return 'Neaktivna';
            if (isExpired(license)) return 'Potekla';
            return 'Aktivna';
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Aktivna': return 'status-active';
                case 'Neaktivna': return 'status-inactive';
                case 'Potekla': return 'status-expired';
                default: return '';
            }
        }

        function getLastCheckClass(lastCheck) {
            return isRecentCheck(lastCheck) ? 'last-check-recent' : 'last-check-old';
        }

        function isExpired(license) {
            return new Date(license.expires_at) < new Date();
        }

        function isLicenseExpired(license) {
            return isExpired(license);
        }

        function isRecentCheck(lastCheck) {
            if (!lastCheck) return false;
            const checkTime = new Date(lastCheck);
            const now = new Date();
            return (now - checkTime) < (24 * 60 * 60 * 1000); // 24 hours
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('sl-SI');
        }

        function formatLastCheck(lastCheck) {
            if (!lastCheck) return 'Nikoli';
            const checkTime = new Date(lastCheck);
            const now = new Date();
            const diffMs = now - checkTime;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffHours < 1) return 'Pred kratkim';
            if (diffHours < 24) return `Pred ${diffHours}h`;
            const diffDays = Math.floor(diffHours / 24);
            return `Pred ${diffDays}d`;
        }

        function convertToCSV(data) {
            const headers = ['Client ID', 'Plan', 'Status', 'Modules', 'Expires At', 'Last Check'];
            const rows = data.map(license => [
                license.client_id,
                license.plan || '',
                getLicenseStatus(license),
                Array.isArray(license.modules) ? license.modules.join(';') : '',
                license.expires_at || '',
                license.last_check || ''
            ]);
            
            return [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Authentication and Security Functions
        let currentUser = null;
        let authToken = localStorage.getItem('omni_auth_token');

        async function login(credentials) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(credentials)
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.requiresTwoFA) {
                        return { requiresTwoFA: true };
                    }
                    
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('omni_auth_token', authToken);
                    localStorage.setItem('omni_current_user', JSON.stringify(currentUser));
                    
                    hideLoginModal();
                    showDashboard();
                    loadSecurityInfo();
                    
                    return { success: true };
                } else {
                    throw new Error(data.message || 'Prijava neuspe≈°na');
                }
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        async function logout() {
            try {
                if (authToken) {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                authToken = null;
                currentUser = null;
                localStorage.removeItem('omni_auth_token');
                localStorage.removeItem('omni_current_user');
                
                hideDashboard();
                showLoginModal();
            }
        }

        async function enable2FA() {
            try {
                const response = await fetch('/api/auth/enable-2fa', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    // Show QR code or setup instructions
                    alert('2FA je bil uspe≈°no omogoƒçen. Skenirajte QR kodo z va≈°o avtentikacijsko aplikacijo.');
                    loadSecurityInfo();
                } else {
                    throw new Error(data.message || 'Napaka pri omogoƒçanju 2FA');
                }
            } catch (error) {
                console.error('2FA enable error:', error);
                alert('Napaka pri omogoƒçanju 2FA: ' + error.message);
            }
        }

        async function loadSecurityInfo() {
            try {
                // Load user stats
                const statsResponse = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    if (statsData.success && statsData.data.auth) {
                        const authStats = statsData.data.auth;
                        document.getElementById('successfulLogins').textContent = authStats.totalLogins || 0;
                        document.getElementById('failedLogins').textContent = authStats.failedLogins || 0;
                        document.getElementById('uniqueUsers').textContent = authStats.uniqueUsers || 0;
                    }
                }

                // Load audit logs
                const auditResponse = await fetch('/api/admin/audit-logs', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (auditResponse.ok) {
                    const auditData = await auditResponse.json();
                    if (auditData.success) {
                        updateAuditLogTable(auditData.data);
                    }
                }

                // Update user info
                if (currentUser) {
                    document.getElementById('userEmail').textContent = currentUser.email || '-';
                    document.getElementById('userRoleText').textContent = currentUser.role || '-';
                    document.getElementById('twoFAStatus').textContent = currentUser.twoFAEnabled ? '‚úÖ Omogoƒçen' : '‚ùå Onemogoƒçen';
                    document.getElementById('lastLogin').textContent = currentUser.lastLogin ? 
                        new Date(currentUser.lastLogin).toLocaleString() : '-';
                    
                    // Show/hide 2FA enable section
                    const enable2FASection = document.getElementById('enable2FASection');
                    if (currentUser.twoFAEnabled) {
                        enable2FASection.classList.add('d-none');
                    } else {
                        enable2FASection.classList.remove('d-none');
                    }
                }
            } catch (error) {
                console.error('Error loading security info:', error);
            }
        }

        function updateAuditLogTable(logs) {
            const tbody = document.getElementById('auditLogTable');
            tbody.innerHTML = '';
            
            if (logs && logs.length > 0) {
                logs.slice(0, 10).forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>${log.event}</td>
                        <td>${log.ip || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Ni podatkov</td></tr>';
            }
        }

        function showLoginModal() {
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        function hideLoginModal() {
            const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            if (loginModal) {
                loginModal.hide();
            }
        }

        function showDashboard() {
            document.getElementById('dashboardContent').style.display = 'block';
        }

        function hideDashboard() {
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function checkAuthentication() {
            const token = localStorage.getItem('omni_auth_token');
            const user = localStorage.getItem('omni_current_user');
            
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showDashboard();
                loadSecurityInfo();
            } else {
                showLoginModal();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const twoFAToken = document.getElementById('twoFAToken').value;
                
                const loginBtn = document.getElementById('loginBtn');
                const loginError = document.getElementById('loginError');
                
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Prijavljam...';
                loginError.classList.add('d-none');
                
                try {
                    const result = await login({ email, password, twoFAToken });
                    
                    if (result.requiresTwoFA) {
                        document.getElementById('twoFASection').classList.remove('d-none');
                        loginError.textContent = 'Vnesite 2FA kodo za nadaljevanje';
                        loginError.classList.remove('d-none');
                    }
                } catch (error) {
                    loginError.textContent = error.message;
                    loginError.classList.remove('d-none');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Prijavi se';
                }
            });

            // Create license form
            if (document.getElementById('createLicenseForm')) {
                document.getElementById('createLicenseForm').addEventListener('submit', handleCreateLicense);
            }
            
            // Notification form
            if (document.getElementById('notificationForm')) {
                document.getElementById('notificationForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    sendNotification();
                });
            }
            
            // Show/hide custom clients input based on target selection
            if (document.getElementById('notificationTarget')) {
                document.getElementById('notificationTarget').addEventListener('change', function() {
                    const customDiv = document.getElementById('customClientsDiv');
                    if (customDiv) {
                        customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
                    }
                });
            }
            
            // Search and filter inputs
            if (document.getElementById('searchInput')) {
                document.getElementById('searchInput').addEventListener('input', applyFilters);
            }
            if (document.getElementById('statusFilter')) {
                document.getElementById('statusFilter').addEventListener('change', applyFilters);
            }
            if (document.getElementById('planFilter')) {
                document.getElementById('planFilter').addEventListener('change', applyFilters);
            }
            if (document.getElementById('moduleFilter')) {
                document.getElementById('moduleFilter').addEventListener('change', applyFilters);
            }
            if (document.getElementById('expiryFilter')) {
                document.getElementById('expiryFilter').addEventListener('change', applyFilters);
            }
            
            // Export button
            if (document.getElementById('exportBtn')) {
                document.getElementById('exportBtn').addEventListener('click', exportLicenses);
            }
        }

        // Enhanced API functions with authentication
        let allLicenses = [];

        async function loadLicenses() {
            if (!authToken) {
                console.warn('No auth token available');
                return;
            }
            
            try {
                const response = await fetch('/api/licenses', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    allLicenses = data.licenses || [];
                    updateLicenseTable();
                    updateLicenseStats();
                }
            } catch (error) {
                console.error('Error loading licenses:', error);
                showToast('Napaka pri nalaganju licenc', 'danger');
            }
        }

        async function loadSystemStats() {
            if (!authToken) {
                console.warn('No auth token available');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    updateSystemStatsDisplay(data.data);
                }
            } catch (error) {
                console.error('Error loading system stats:', error);
                showToast('Napaka pri nalaganju sistemskih statistik', 'danger');
            }
        }

        async function sendNotification() {
            if (!authToken) {
                showToast('Niste prijavljeni', 'danger');
                return;
            }
            
            const target = document.getElementById('notificationTarget').value;
            const message = document.getElementById('notificationMessage').value;
            const customClients = document.getElementById('customClients').value;
            
            try {
                const response = await fetch('/api/notifications/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        target,
                        message,
                        customClients: customClients ? customClients.split(',').map(c => c.trim()) : []
                    })
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast('Obvestilo uspe≈°no poslano', 'success');
                    document.getElementById('notificationForm').reset();
                } else {
                    showToast('Napaka pri po≈°iljanju obvestila: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error sending notification:', error);
                showToast('Napaka pri po≈°iljanju obvestila', 'danger');
            }
        }

        function updateLicenseTable() {
            // Placeholder for license table update
            console.log('Updating license table with', allLicenses.length, 'licenses');
        }

        function updateLicenseStats() {
            // Placeholder for license stats update
            console.log('Updating license stats');
        }

        function updateSystemStatsDisplay(stats) {
            // Placeholder for system stats display update
            console.log('Updating system stats display', stats);
        }

        function initializeCharts() {
            // Placeholder for chart initialization
            console.log('Initializing charts');
        }

        function connectWebSocket() {
            // Placeholder for WebSocket connection
            console.log('Connecting WebSocket');
        }

        // Access Control System
        // currentUserRole je ≈æe deklariran zgoraj
        const rolePermissions = {
            'super-admin': {
                canCreate: true,
                canDelete: true,
                canModify: true,
                canViewAll: true,
                canSendNotifications: true,
                canManageUsers: true,
                canViewDebug: true,
                level: 4
            },
            'admin': {
                canCreate: true,
                canDelete: true,
                canModify: true,
                canViewAll: true,
                canSendNotifications: true,
                canManageUsers: false,
                canViewDebug: true,
                level: 3
            },
            'support': {
                canCreate: false,
                canDelete: false,
                canModify: true,
                canViewAll: true,
                canSendNotifications: true,
                canManageUsers: false,
                canViewDebug: false,
                level: 2
            },
            'moderator': {
                canCreate: false,
                canDelete: false,
                canModify: false,
                canViewAll: true,
                canSendNotifications: false,
                canManageUsers: false,
                canViewDebug: false,
                level: 1
            }
        };

        function logAccessAction(action, allowed, reason = '') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            const className = allowed ? 'text-success' : 'text-danger';
            const icon = allowed ? '‚úì' : '‚úó';
            
            logEntry.className = className;
            logEntry.innerHTML = `[${timestamp}] ${icon} ${currentUserRole.toUpperCase()}: ${action} ${reason ? '(' + reason + ')' : ''}`;
            
            const debugLog = document.getElementById('accessDebugLog');
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // Keep only last 50 entries
            while (debugLog.children.length > 50) {
                debugLog.removeChild(debugLog.firstChild);
            }
            
            console.log(`[ACCESS] ${currentUserRole.toUpperCase()}: ${action} - ${allowed ? 'ALLOWED' : 'DENIED'} ${reason}`);
        }

        function checkPermission(action) {
            const permissions = rolePermissions[currentUserRole];
            let allowed = false;
            let reason = '';
            
            switch(action) {
                case 'create_license':
                    allowed = permissions.canCreate;
                    reason = allowed ? '' : 'Insufficient permissions';
                    break;
                case 'delete_license':
                    allowed = permissions.canDelete;
                    reason = allowed ? '' : 'Delete not allowed for this role';
                    break;
                case 'modify_license':
                    allowed = permissions.canModify;
                    reason = allowed ? '' : 'Modify not allowed for this role';
                    break;
                case 'send_notification':
                    allowed = permissions.canSendNotifications;
                    reason = allowed ? '' : 'Notification sending restricted';
                    break;
                case 'view_debug':
                    allowed = permissions.canViewDebug;
                    reason = allowed ? '' : 'Debug access restricted';
                    break;
                default:
                    allowed = false;
                    reason = 'Unknown action';
            }
            
            logAccessAction(action, allowed, reason);
            return allowed;
        }

        function changeUserRole(newRole) {
            const oldRole = currentUserRole;
            currentUserRole = newRole;
            
            // Update UI
            const roleDisplay = document.getElementById('roleDisplay');
            const roleClasses = ['role-super-admin', 'role-admin', 'role-support', 'role-moderator'];
            roleClasses.forEach(cls => roleDisplay.classList.remove(cls));
            
            let icon = 'fas fa-user-shield';
            let displayName = newRole.charAt(0).toUpperCase() + newRole.slice(1).replace('-', ' ');
            
            switch(newRole) {
                case 'super-admin':
                    roleDisplay.classList.add('role-super-admin');
                    icon = 'fas fa-crown';
                    break;
                case 'admin':
                    roleDisplay.classList.add('role-admin');
                    icon = 'fas fa-user-shield';
                    break;
                case 'support':
                    roleDisplay.classList.add('role-support');
                    icon = 'fas fa-headset';
                    break;
                case 'moderator':
                    roleDisplay.classList.add('role-moderator');
                    icon = 'fas fa-user-check';
                    break;
            }
            
            roleDisplay.innerHTML = `<i class="${icon}"></i> ${displayName}`;
            
            // Log role change
            logAccessAction(`Role changed from ${oldRole} to ${newRole}`, true, 'Role switch successful');
            
            // Update UI elements based on permissions
            updateUIBasedOnRole();
            
            showToast(`Vloga spremenjena na: ${displayName}`, 'info');
        }

        function updateUIBasedOnRole() {
            const permissions = rolePermissions[currentUserRole];
            
            // Show/hide create license form
            const createForm = document.querySelector('.card:has(#createLicenseForm)');
            if (createForm) {
                createForm.style.display = permissions.canCreate ? 'block' : 'none';
            }
            
            // Show/hide notification form
            const notificationForm = document.querySelector('.card:has(#notificationForm)');
            if (notificationForm) {
                notificationForm.style.display = permissions.canSendNotifications ? 'block' : 'none';
            }
            
            // Show/hide debug panel
            const debugPanel = document.getElementById('accessDebugPanel');
            if (debugPanel) {
                debugPanel.style.display = permissions.canViewDebug ? 'block' : 'none';
            }
            
            // Update action buttons in license table
            const actionButtons = document.querySelectorAll('.license-actions button');
            actionButtons.forEach(button => {
                if (button.textContent.includes('Bri≈°i') || button.classList.contains('btn-danger')) {
                    button.disabled = !permissions.canDelete;
                    button.title = permissions.canDelete ? '' : 'Brisanje ni dovoljeno za va≈°o vlogo';
                }
                if (button.textContent.includes('Podalj≈°aj') || button.classList.contains('btn-warning')) {
                    button.disabled = !permissions.canModify;
                    button.title = permissions.canModify ? '' : 'Spreminjanje ni dovoljeno za va≈°o vlogo';
                }
            });
            
            logAccessAction(`UI updated for role ${currentUserRole}`, true, `Level ${permissions.level} permissions applied`);
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div class="toast align-items-center text-bg-${type} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Initialize access control system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuthentication();
            
            // Add logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Add security panel toggle
            const securityPanelBtn = document.getElementById('securityPanelBtn');
            if (securityPanelBtn) {
                securityPanelBtn.addEventListener('click', function() {
                    const securityPanel = document.getElementById('securityPanel');
                    if (securityPanel.style.display === 'none' || !securityPanel.style.display) {
                        securityPanel.style.display = 'block';
                        loadSecurityInfo();
                    } else {
                        securityPanel.style.display = 'none';
                    }
                });
            }
            
            // Add 2FA enable functionality
            const enable2FABtn = document.getElementById('enable2FABtn');
            if (enable2FABtn) {
                enable2FABtn.addEventListener('click', enable2FA);
            }
            
            // Initialize with default admin role
            logAccessAction('system_init', true, 'Access control system initialized');
            updateUIBasedOnRole();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize other components only if authenticated
            if (authToken) {
                initializeCharts();
                connectWebSocket();
                loadLicenses();
                loadSystemStats();
                loadSecurityInfo();
            }
            
            logAccessAction('system_ready', true, 'Dashboard fully initialized');
        });
    </script>
</body>
</html>