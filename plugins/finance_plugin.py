# Finance Management Plugin
import json
import os
from datetime import datetime, timedelta
import re
import sys
sys.path.append('..')

# Definiramo PluginBase lokalno za neodvisnost
class PluginBase:
    """Osnova za vse plugin-e"""
    name = "base"
    description = "Generic plugin"
    version = "1.0.0"
    author = "OmniCore"
    enabled = True
    capabilities = []
    dependencies = []
    
    def handle(self, query, context=None):
        raise NotImplementedError("Vsak plugin mora implementirati handle()")
    
    def can_handle(self, query):
        """Vrni oceno 0-1 kako dobro plugin lahko obravnava zahtevo"""
        return 0.0
    
    def get_help(self):
        """Vrni pomoƒç za plugin"""
        return f"Plugin {self.name}: {self.description}"
    
    def update_stats(self, success=True):
        """Posodobi statistike plugin-a"""
        pass
    
    def health_check(self):
        """Preveri zdravje plugin-a"""
        try:
            # Preveri dostopnost podatkovnih datotek
            transactions_accessible = os.path.exists(self.transactions_file)
            budgets_accessible = os.path.exists(self.budgets_file)
            
            # Preveri velikost podatkov
            transactions_count = len(self.transactions)
            budgets_count = len(self.budgets)
            
            # Doloƒçi status
            if transactions_accessible and budgets_accessible:
                status = "healthy"
            elif transactions_accessible or budgets_accessible:
                status = "standby"  # Delno dostopen
            else:
                status = "error"
            
            return {
                "status": status,
                "timestamp": datetime.now().timestamp(),
                "details": {
                    "transactions_accessible": transactions_accessible,
                    "budgets_accessible": budgets_accessible,
                    "transactions_count": transactions_count,
                    "budgets_count": budgets_count,
                    "data_files": {
                        "transactions": self.transactions_file,
                        "budgets": self.budgets_file
                    }
                }
            }
        except Exception as e:
            return {
                "status": "error",
                "timestamp": datetime.now().timestamp(),
                "error": str(e)
            }


class Plugin(PluginBase):
    name = "finance"
    description = "Finanƒçno upravljanje, proraƒçuni, stro≈°ki, prihodki, analize"
    
    def __init__(self):
        self.transactions_file = "data/transactions.json"
        self.budgets_file = "data/budgets.json"
        self.ensure_data_dir()
        self.transactions = self.load_transactions()
        self.budgets = self.load_budgets()
    
    def ensure_data_dir(self):
        """Ustvari data direktorij ƒçe ne obstaja"""
        os.makedirs("data", exist_ok=True)
    
    def load_transactions(self):
        """Nalo≈æi transakcije iz datoteke"""
        if os.path.exists(self.transactions_file):
            try:
                with open(self.transactions_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                return []
        return []
    
    def load_budgets(self):
        """Nalo≈æi proraƒçune iz datoteke"""
        if os.path.exists(self.budgets_file):
            try:
                with open(self.budgets_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                return []
        return []
    
    def save_transactions(self):
        """Shrani transakcije v datoteko"""
        with open(self.transactions_file, 'w', encoding='utf-8') as f:
            json.dump(self.transactions, f, ensure_ascii=False, indent=2)
    
    def save_budgets(self):
        """Shrani proraƒçune v datoteko"""
        with open(self.budgets_file, 'w', encoding='utf-8') as f:
            json.dump(self.budgets, f, ensure_ascii=False, indent=2)
    
    def handle(self, query, context=None):
        """Obravnava finanƒçne zahteve"""
        query_lower = query.lower()
        
        # Dodaj transakcijo
        if any(word in query_lower for word in ['dodaj', 'stro≈°ek', 'prihodek', 'plaƒçilo', 'expense', 'income']):
            return self.add_transaction(query)
        
        # Finanƒçni pregled
        elif any(word in query_lower for word in ['pregled', 'bilanca', 'stanje', 'balance', 'overview']):
            return self.financial_overview()
        
        # Proraƒçun
        elif any(word in query_lower for word in ['proraƒçun', 'budget', 'naƒçrt']):
            return self.manage_budget(query)
        
        # Analiza
        elif any(word in query_lower for word in ['analiza', 'poroƒçilo', 'report', 'analysis']):
            return self.financial_analysis(query)
        
        # Kategorije
        elif any(word in query_lower for word in ['kategorija', 'category', 'tip']):
            return self.category_analysis(query)
        
        else:
            return self.get_help()
    
    def add_transaction(self, query):
        """Dodaj novo transakcijo"""
        # Izvleci znesek iz zahteve
        amount_match = re.search(r'(\d+(?:[.,]\d{1,2})?)\s*‚Ç¨?', query)
        amount = 0
        
        if amount_match:
            amount_str = amount_match.group(1).replace(',', '.')
            amount = float(amount_str)
        
        # Doloƒçi tip transakcije
        transaction_type = "expense"  # privzeto stro≈°ek
        if any(word in query.lower() for word in ['prihodek', 'dohodek', 'income', 'revenue', 'zaslu≈æek']):
            transaction_type = "income"
        
        # Izvleci opis
        description = query
        for prefix in ['dodaj stro≈°ek:', 'dodaj prihodek:', 'stro≈°ek:', 'prihodek:', 'plaƒçilo:']:
            if prefix in query.lower():
                description = query[query.lower().find(prefix) + len(prefix):].strip()
                break
        
        # Oƒçisti opis od zneska
        if amount_match:
            description = description.replace(amount_match.group(0), '').strip()
        
        if not description or len(description) < 3:
            description = f"{'Prihodek' if transaction_type == 'income' else 'Stro≈°ek'} - {datetime.now().strftime('%H:%M')}"
        
        # Doloƒçi kategorijo
        category = self.determine_category(description, transaction_type)
        
        new_transaction = {
            "id": len(self.transactions) + 1,
            "type": transaction_type,
            "amount": amount,
            "description": description,
            "category": category,
            "date": datetime.now().isoformat(),
            "created": datetime.now().isoformat()
        }
        
        self.transactions.append(new_transaction)
        self.save_transactions()
        
        type_icon = "üí∞" if transaction_type == "income" else "üí∏"
        return f"{type_icon} **Transakcija dodana:**\nüìù {description}\nüíµ ‚Ç¨{amount:.2f}\nüìÇ {category}\nüÜî ID: {new_transaction['id']}"
    
    def determine_category(self, description, transaction_type):
        """Doloƒçi kategorijo na podlagi opisa"""
        desc_lower = description.lower()
        
        if transaction_type == "income":
            if any(word in desc_lower for word in ['plaƒça', 'salary', 'work']):
                return "plaƒça"
            elif any(word in desc_lower for word in ['projekt', 'freelance', 'consulting']):
                return "projekti"
            elif any(word in desc_lower for word in ['investicija', 'dividend', 'interest']):
                return "investicije"
            else:
                return "ostali_prihodki"
        else:  # expense
            if any(word in desc_lower for word in ['hrana', 'restavracija', 'food', 'restaurant']):
                return "hrana"
            elif any(word in desc_lower for word in ['transport', 'gorivo', 'fuel', 'bus', 'taxi']):
                return "transport"
            elif any(word in desc_lower for word in ['stanovanje', 'najemnina', 'rent', 'utilities']):
                return "stanovanje"
            elif any(word in desc_lower for word in ['zdravje', 'health', 'doctor', 'medicine']):
                return "zdravje"
            elif any(word in desc_lower for word in ['zabava', 'entertainment', 'kino', 'cinema']):
                return "zabava"
            elif any(word in desc_lower for word in ['oblaƒçila', 'clothes', 'shopping']):
                return "nakupi"
            else:
                return "ostalo"
    
    def financial_overview(self):
        """Finanƒçni pregled"""
        if not self.transactions:
            return "üí∞ **Finanƒçni pregled:**\n\n≈†e ni transakcij. Dodajte prvo transakcijo!"
        
        # Izraƒçunaj skupne zneske
        total_income = sum(t['amount'] for t in self.transactions if t['type'] == 'income')
        total_expenses = sum(t['amount'] for t in self.transactions if t['type'] == 'expense')
        balance = total_income - total_expenses
        
        # Zadnji mesec
        last_month = datetime.now() - timedelta(days=30)
        recent_transactions = [t for t in self.transactions 
                             if datetime.fromisoformat(t['date']) > last_month]
        
        monthly_income = sum(t['amount'] for t in recent_transactions if t['type'] == 'income')
        monthly_expenses = sum(t['amount'] for t in recent_transactions if t['type'] == 'expense')
        monthly_balance = monthly_income - monthly_expenses
        
        # Status
        status_icon = "üü¢" if balance > 0 else "üî¥" if balance < 0 else "üü°"
        monthly_status = "üìà" if monthly_balance > 0 else "üìâ" if monthly_balance < 0 else "‚û°Ô∏è"
        
        result = f"""
üí∞ **Finanƒçni pregled:**

üíµ **Skupno stanje:**
‚Ä¢ Prihodki: ‚Ç¨{total_income:,.2f}
‚Ä¢ Stro≈°ki: ‚Ç¨{total_expenses:,.2f}
‚Ä¢ Bilanca: ‚Ç¨{balance:,.2f} {status_icon}

üìÖ **Zadnjih 30 dni:**
‚Ä¢ Prihodki: ‚Ç¨{monthly_income:,.2f}
‚Ä¢ Stro≈°ki: ‚Ç¨{monthly_expenses:,.2f}
‚Ä¢ Bilanca: ‚Ç¨{monthly_balance:,.2f} {monthly_status}

üìä **Statistike:**
‚Ä¢ ≈†tevilo transakcij: {len(self.transactions)}
‚Ä¢ Povpreƒçen stro≈°ek: ‚Ç¨{total_expenses/max(len([t for t in self.transactions if t['type'] == 'expense']), 1):.2f}
‚Ä¢ Povpreƒçen prihodek: ‚Ç¨{total_income/max(len([t for t in self.transactions if t['type'] == 'income']), 1):.2f}
        """
        
        return result.strip()
    
    def manage_budget(self, query):
        """Upravljanje proraƒçuna"""
        query_lower = query.lower()
        
        if 'dodaj' in query_lower or 'ustvari' in query_lower:
            return self.create_budget(query)
        elif 'prika≈æi' in query_lower or 'seznam' in query_lower:
            return self.show_budgets()
        else:
            return self.budget_status()
    
    def create_budget(self, query):
        """Ustvari nov proraƒçun"""
        # Enostaven parser za proraƒçun
        # Format: "dodaj proraƒçun [kategorija] [znesek]"
        
        amount_match = re.search(r'(\d+(?:[.,]\d{1,2})?)\s*‚Ç¨?', query)
        if not amount_match:
            return "‚ùå Prosim, navedite znesek proraƒçuna (npr. 'dodaj proraƒçun hrana 300‚Ç¨')"
        
        amount = float(amount_match.group(1).replace(',', '.'))
        
        # Doloƒçi kategorijo
        words = query.lower().split()
        category = "splo≈°no"
        
        categories = ['hrana', 'transport', 'stanovanje', 'zabava', 'nakupi', 'zdravje']
        for cat in categories:
            if cat in query.lower():
                category = cat
                break
        
        # Preveri ƒçe proraƒçun ≈æe obstaja
        existing_budget = next((b for b in self.budgets if b['category'] == category), None)
        
        if existing_budget:
            existing_budget['amount'] = amount
            existing_budget['updated'] = datetime.now().isoformat()
            action = "posodobljen"
        else:
            new_budget = {
                "id": len(self.budgets) + 1,
                "category": category,
                "amount": amount,
                "period": "monthly",
                "created": datetime.now().isoformat(),
                "updated": datetime.now().isoformat()
            }
            self.budgets.append(new_budget)
            action = "ustvarjen"
        
        self.save_budgets()
        
        return f"üí∞ **Proraƒçun {action}:**\nüìÇ Kategorija: {category}\nüíµ Znesek: ‚Ç¨{amount:.2f}/mesec"
    
    def show_budgets(self):
        """Prika≈æi vse proraƒçune"""
        if not self.budgets:
            return "üìä **Proraƒçuni:**\n\n≈†e ni nastavljenih proraƒçunov."
        
        result = "üìä **Nastavljeni proraƒçuni:**\n\n"
        
        for budget in self.budgets:
            # Izraƒçunaj porabo za kategorijo
            category_expenses = sum(t['amount'] for t in self.transactions 
                                  if t['type'] == 'expense' and t['category'] == budget['category'])
            
            percentage = (category_expenses / budget['amount'] * 100) if budget['amount'] > 0 else 0
            status_icon = "üü¢" if percentage < 80 else "üü°" if percentage < 100 else "üî¥"
            
            result += f"{status_icon} **{budget['category'].upper()}**\n"
            result += f"   üí∞ Proraƒçun: ‚Ç¨{budget['amount']:.2f}\n"
            result += f"   üí∏ Porabljeno: ‚Ç¨{category_expenses:.2f} ({percentage:.1f}%)\n"
            result += f"   üíµ Ostane: ‚Ç¨{max(0, budget['amount'] - category_expenses):.2f}\n\n"
        
        return result.strip()
    
    def budget_status(self):
        """Status proraƒçuna"""
        if not self.budgets:
            return "üìä Ni nastavljenih proraƒçunov. Uporabite 'dodaj proraƒçun [kategorija] [znesek]'"
        
        # Skupni pregled proraƒçuna
        total_budget = sum(b['amount'] for b in self.budgets)
        total_spent = 0
        
        result = "üìä **Status proraƒçuna:**\n\n"
        
        over_budget = []
        for budget in self.budgets:
            category_expenses = sum(t['amount'] for t in self.transactions 
                                  if t['type'] == 'expense' and t['category'] == budget['category'])
            total_spent += category_expenses
            
            if category_expenses > budget['amount']:
                over_budget.append((budget['category'], category_expenses - budget['amount']))
        
        overall_percentage = (total_spent / total_budget * 100) if total_budget > 0 else 0
        status_icon = "üü¢" if overall_percentage < 80 else "üü°" if overall_percentage < 100 else "üî¥"
        
        result += f"{status_icon} **Skupno:**\n"
        result += f"üí∞ Proraƒçun: ‚Ç¨{total_budget:.2f}\n"
        result += f"üí∏ Porabljeno: ‚Ç¨{total_spent:.2f} ({overall_percentage:.1f}%)\n"
        result += f"üíµ Ostane: ‚Ç¨{max(0, total_budget - total_spent):.2f}\n\n"
        
        if over_budget:
            result += "‚ö†Ô∏è **Prekoraƒçitve:**\n"
            for category, amount in over_budget:
                result += f"‚Ä¢ {category}: +‚Ç¨{amount:.2f}\n"
        
        return result.strip()
    
    def financial_analysis(self, query):
        """Finanƒçna analiza"""
        if not self.transactions:
            return "üìä Ni podatkov za analizo. Dodajte transakcije."
        
        # Analiza po kategorijah
        categories = {}
        for transaction in self.transactions:
            if transaction['type'] == 'expense':
                cat = transaction['category']
                categories[cat] = categories.get(cat, 0) + transaction['amount']
        
        # Sortiraj po znesku
        sorted_categories = sorted(categories.items(), key=lambda x: x[1], reverse=True)
        
        # Meseƒçni trendi
        monthly_data = {}
        for transaction in self.transactions:
            date = datetime.fromisoformat(transaction['date'])
            month_key = date.strftime('%Y-%m')
            
            if month_key not in monthly_data:
                monthly_data[month_key] = {'income': 0, 'expenses': 0}
            
            monthly_data[month_key][transaction['type'] + 's'] += transaction['amount']
        
        result = f"""
üìä **Finanƒçna analiza:**

üí∏ **Stro≈°ki po kategorijah:**
"""
        
        for category, amount in sorted_categories[:5]:
            percentage = (amount / sum(categories.values()) * 100) if categories else 0
            result += f"‚Ä¢ {category}: ‚Ç¨{amount:.2f} ({percentage:.1f}%)\n"
        
        result += f"\nüìà **Meseƒçni trendi:**\n"
        for month, data in sorted(monthly_data.items())[-3:]:  # Zadnji 3 meseci
            balance = data['income'] - data['expenses']
            trend_icon = "üìà" if balance > 0 else "üìâ"
            result += f"{trend_icon} {month}: ‚Ç¨{balance:+.2f} (prihodki: ‚Ç¨{data['income']:.2f}, stro≈°ki: ‚Ç¨{data['expenses']:.2f})\n"
        
        return result.strip()
    
    def category_analysis(self, query):
        """Analiza po kategorijah"""
        # Analiza stro≈°kov po kategorijah
        expense_categories = {}
        income_categories = {}
        
        for transaction in self.transactions:
            cat = transaction['category']
            amount = transaction['amount']
            
            if transaction['type'] == 'expense':
                expense_categories[cat] = expense_categories.get(cat, 0) + amount
            else:
                income_categories[cat] = income_categories.get(cat, 0) + amount
        
        result = "üìÇ **Analiza po kategorijah:**\n\n"
        
        if expense_categories:
            result += "üí∏ **Stro≈°ki:**\n"
            for cat, amount in sorted(expense_categories.items(), key=lambda x: x[1], reverse=True):
                result += f"‚Ä¢ {cat}: ‚Ç¨{amount:.2f}\n"
            result += "\n"
        
        if income_categories:
            result += "üí∞ **Prihodki:**\n"
            for cat, amount in sorted(income_categories.items(), key=lambda x: x[1], reverse=True):
                result += f"‚Ä¢ {cat}: ‚Ç¨{amount:.2f}\n"
        
        return result.strip()
    
    def get_help(self):
        """Pomoƒç za uporabo"""
        return """
üí∞ **Finance Plugin - Pomoƒç:**
‚Ä¢ `dodaj stro≈°ek: [opis] [znesek]‚Ç¨` - Dodaj stro≈°ek
‚Ä¢ `dodaj prihodek: [opis] [znesek]‚Ç¨` - Dodaj prihodek
‚Ä¢ `finanƒçni pregled` - Skupno stanje
‚Ä¢ `dodaj proraƒçun [kategorija] [znesek]‚Ç¨` - Nastavi proraƒçun
‚Ä¢ `prika≈æi proraƒçune` - Status proraƒçunov
‚Ä¢ `finanƒçna analiza` - Podrobna analiza

**Primeri:**
- "dodaj stro≈°ek: kosilo 12.50‚Ç¨"
- "dodaj prihodek: freelance projekt 500‚Ç¨"
- "dodaj proraƒçun hrana 300‚Ç¨"
- "finanƒçni pregled"

**Kategorije:**
- Stro≈°ki: hrana, transport, stanovanje, zabava, nakupi, zdravje
- Prihodki: plaƒça, projekti, investicije
        """
    def get_info(self):
        """Vrni informacije o plugin-u"""
        return {
            "name": self.name,
            "version": getattr(self, 'version', '1.0.0'),
            "description": self.description,
            "author": getattr(self, 'author', 'OmniCore'),
            "capabilities": getattr(self, 'capabilities', [])
        }