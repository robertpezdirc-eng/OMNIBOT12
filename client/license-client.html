<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîπ Omni Ultimate - Odjemalski Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-valid { background-color: #48bb78; }
        .status-expired { background-color: #f56565; }
        .status-warning { background-color: #ed8936; }
        .status-checking { background-color: #4299e1; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .license-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .license-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-card p {
            color: #718096;
            font-size: 1.2em;
            font-weight: 500;
        }

        .modules-section {
            margin-top: 30px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .module-card.unlocked {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .module-card.locked {
            border-color: #f56565;
            background: rgba(245, 101, 101, 0.1);
            opacity: 0.6;
        }

        .module-card h4 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        .module-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .status-unlocked {
            background: #48bb78;
            color: white;
        }

        .status-locked {
            background: #f56565;
            color: white;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
        }

        .logs {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-timestamp {
            color: #888;
            margin-right: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Omni License Client Panel</h1>
            <p>Upravljanje licenc in modulov</p>
        </div>

        <div class="connection-status" id="connectionStatus">
            <span class="status-indicator status-checking"></span>
            Preverjam povezavo...
        </div>

        <div class="license-panel">
            <h2>üìã Informacije o licenci</h2>
            
            <div class="license-info" id="licenseInfo">
                <div class="info-card">
                    <h3>Client ID</h3>
                    <p id="clientId">-</p>
                </div>
                <div class="info-card">
                    <h3>Plan</h3>
                    <p id="plan">-</p>
                </div>
                <div class="info-card">
                    <h3>Status</h3>
                    <p id="status">
                        <span class="status-indicator status-checking"></span>
                        Preverjam...
                    </p>
                </div>
                <div class="info-card">
                    <h3>Poteƒçe</h3>
                    <p id="expiresAt">-</p>
                </div>
            </div>

            <div class="modules-section">
                <h3>üß© Aktivni moduli</h3>
                <div class="modules-grid" id="modulesGrid">
                    <!-- Moduli se bodo dinamiƒçno nalo≈æili -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="checkLicense()">üîÑ Preveri licenco</button>
                <button class="btn" onclick="clearLogs()">üóëÔ∏è Poƒçisti dnevnike</button>
            </div>
        </div>

        <div class="logs" id="logs">
            <div class="log-entry">
                <span class="log-timestamp">[INIT]</span>
                <span>Client Panel inicializiran</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        class LicenseClient {
            constructor() {
                this.socket = null;
                this.licenseToken = null;
                this.apiUrl = 'http://localhost:3001';
                this.serverUrl = 'http://localhost:3001'; // HTTP
                this.wsUrl = 'ws://localhost:3001'; // WS
                this.licenseData = null;
                
                this.init();
            }

            init() {
                this.log('Inicializacija License Client...');
                this.loadSecureStorage();
                this.connectWebSocket();
                this.checkLicense();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
                
                const logs = document.getElementById('logs');
                logs.appendChild(logEntry);
                logs.scrollTop = logs.scrollHeight;
            }

            loadSecureStorage() {
                // Simulacija secure storage - v produkciji uporabi Electron secure storage
                this.licenseToken = localStorage.getItem('license_token');
                if (this.licenseToken) {
                    this.log('License token nalo≈æen iz secure storage');
                } else {
                    this.log('License token ni najden v secure storage');
                }
            }

            saveSecureStorage(token) {
                // Simulacija secure storage
                localStorage.setItem('license_token', token);
                this.licenseToken = token;
                this.log('License token shranjen v secure storage');
            }

            connectWebSocket() {
                try {
                    this.log('Vzpostavljam WebSocket povezavo...');
                    this.socket = io(this.wsUrl, {
                        transports: ['websocket'],
                        secure: true,
                        rejectUnauthorized: false // Za development
                    });

                    this.socket.on('connect', () => {
                        this.log('‚úÖ WebSocket povezava vzpostavljena');
                        this.updateConnectionStatus('connected');
                    });

                    this.socket.on('disconnect', () => {
                        this.log('‚ùå WebSocket povezava prekinjena');
                        this.updateConnectionStatus('disconnected');
                    });

                    this.socket.on('license_update', (data) => {
                        this.log('üì° Prejel license_update event');
                        this.handleLicenseUpdate(data);
                    });

                    this.socket.on('connect_error', (error) => {
                        this.log(`‚ùå WebSocket napaka: ${error.message}`);
                        this.updateConnectionStatus('error');
                    });

                } catch (error) {
                    this.log(`‚ùå Napaka pri WebSocket povezavi: ${error.message}`);
                    this.updateConnectionStatus('error');
                }
            }

            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connectionStatus');
                const indicator = statusEl.querySelector('.status-indicator');
                
                switch (status) {
                    case 'connected':
                        indicator.className = 'status-indicator status-valid';
                        statusEl.innerHTML = '<span class="status-indicator status-valid"></span>Povezan';
                        break;
                    case 'disconnected':
                        indicator.className = 'status-indicator status-expired';
                        statusEl.innerHTML = '<span class="status-indicator status-expired"></span>Prekinjen';
                        break;
                    case 'error':
                        indicator.className = 'status-indicator status-warning';
                        statusEl.innerHTML = '<span class="status-indicator status-warning"></span>Napaka';
                        break;
                    default:
                        indicator.className = 'status-indicator status-checking';
                        statusEl.innerHTML = '<span class="status-indicator status-checking"></span>Preverjam...';
                }
            }

            async checkLicense() {
                this.log('üîç Preverjam licenco...');
                
                try {
                    const response = await fetch(`${this.serverUrl}/api/license/check`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': this.licenseToken ? `Bearer ${this.licenseToken}` : ''
                        },
                        body: JSON.stringify({
                            client_id: 'demo-client-001'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.handleLicenseData(data);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                } catch (error) {
                    this.log(`‚ùå Napaka pri preverjanju licence: ${error.message}`);
                    this.handleLicenseError();
                }
            }

            handleLicenseData(data) {
                this.log('‚úÖ Licenca uspe≈°no preverjena');
                this.licenseData = data;
                
                if (data.license_token) {
                    this.saveSecureStorage(data.license_token);
                }

                this.updateLicenseUI(data);
                
                if (data.valid) {
                    this.unlockModules(data.modules || []);
                } else {
                    this.lockAllModules();
                }
            }

            handleLicenseError() {
                this.updateLicenseUI({
                    client_id: 'N/A',
                    plan: 'N/A',
                    status: 'error',
                    expires_at: 'N/A',
                    valid: false,
                    modules: []
                });
                this.lockAllModules();
            }

            handleLicenseUpdate(data) {
                this.log('üîÑ Posodabljam licenco zaradi WebSocket dogodka');
                this.checkLicense();
            }

            updateLicenseUI(data) {
                document.getElementById('clientId').textContent = data.client_id || 'N/A';
                document.getElementById('plan').textContent = data.plan || 'N/A';
                document.getElementById('expiresAt').textContent = data.expires_at || 'N/A';
                
                const statusEl = document.getElementById('status');
                let statusClass = 'status-checking';
                let statusText = 'Neznano';
                
                if (data.status === 'error') {
                    statusClass = 'status-expired';
                    statusText = 'Napaka';
                } else if (data.valid) {
                    statusClass = 'status-valid';
                    statusText = 'Veljavna';
                } else {
                    statusClass = 'status-expired';
                    statusText = 'Potekla';
                }
                
                statusEl.innerHTML = `<span class="status-indicator ${statusClass}"></span>${statusText}`;
            }

            unlockModules(activeModules) {
                this.log(`üîì Odklepam module: ${activeModules.join(', ')}`);
                
                const allModules = [
                    'tourism', 'finance', 'analytics', 'ai-assistant', 
                    'reporting', 'automation', 'integrations', 'advanced-features'
                ];
                
                const modulesGrid = document.getElementById('modulesGrid');
                modulesGrid.innerHTML = '';
                
                allModules.forEach(module => {
                    const isUnlocked = activeModules.includes(module);
                    const moduleCard = document.createElement('div');
                    moduleCard.className = `module-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                    
                    moduleCard.innerHTML = `
                        <h4>${this.getModuleName(module)}</h4>
                        <div class="module-status ${isUnlocked ? 'status-unlocked' : 'status-locked'}">
                            ${isUnlocked ? 'üîì Odklenjen' : 'üîí Zaklenjen'}
                        </div>
                    `;
                    
                    modulesGrid.appendChild(moduleCard);
                });
            }

            lockAllModules() {
                this.log('üîí Zaklepam vse module');
                this.unlockModules([]); // Po≈°lje prazen seznam
            }

            getModuleName(module) {
                const names = {
                    'tourism': 'üèñÔ∏è Turizem',
                    'finance': 'üí∞ Finance',
                    'analytics': 'üìä Analitika',
                    'ai-assistant': 'ü§ñ AI Asistent',
                    'reporting': 'üìã Poroƒçila',
                    'automation': '‚öôÔ∏è Avtomatizacija',
                    'integrations': 'üîó Integracije',
                    'advanced-features': '‚≠ê Napredne funkcije'
                };
                return names[module] || module;
            }
        }

        // Globalne funkcije
        let licenseClient;

        function checkLicense() {
            if (licenseClient) {
                licenseClient.checkLicense();
            }
        }

        function clearLogs() {
            const logs = document.getElementById('logs');
            logs.innerHTML = '<div class="log-entry"><span class="log-timestamp">[CLEAR]</span><span>Dnevniki poƒçi≈°ƒçeni</span></div>';
        }

        // Inicializacija ob nalaganju strani
        document.addEventListener('DOMContentLoaded', () => {
            licenseClient = new LicenseClient();
        });
    </script>
</body>
</html>