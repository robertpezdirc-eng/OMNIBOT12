<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Global License System - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .licenses-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #68d391 0%, #48bb78 100%);
            color: white;
        }
        
        .search-box {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            flex: 1;
            min-width: 200px;
        }
        
        .licenses-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .licenses-table th,
        .licenses-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .licenses-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-expired {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-suspended {
            background: #feebc8;
            color: #7b341e;
        }
        
        .activity-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .activity-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        .activity-time {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Omni Global License System</h1>
            <p><span class="status-indicator"></span>Admin Panel - Real-time License Management</p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h3>üìä Skupaj licenc</h3>
                <div class="stat-number" id="totalLicenses">-</div>
                <p>Vse izdane licence</p>
            </div>
            <div class="card">
                <h3>‚úÖ Aktivne licence</h3>
                <div class="stat-number" id="activeLicenses">-</div>
                <p>Trenutno veljavne</p>
            </div>
            <div class="card">
                <h3>‚ö†Ô∏è Potekle licence</h3>
                <div class="stat-number" id="expiredLicenses">-</div>
                <p>Potrebujejo podalj≈°anje</p>
            </div>
        </div>
        
        <div class="main-content">
            <div class="licenses-panel">
                <h2>üîë Upravljanje licenc</h2>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="showCreateModal()">‚ûï Nova licenca</button>
                    <button class="btn btn-success" onclick="refreshLicenses()">üîÑ Osve≈æi</button>
                    <input type="text" class="search-box" placeholder="üîç I≈°ƒçi licence..." id="searchBox" onkeyup="filterLicenses()">
                </div>
                
                <div id="licensesContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Nalagam licence...</p>
                    </div>
                </div>
            </div>
            
            <div class="activity-panel">
                <h2>üì° Aktivnost v realnem ƒçasu</h2>
                <div id="activityFeed">
                    <div class="activity-item">
                        <div class="activity-time">Sistem se zaganja...</div>
                        <div>Povezovanje z Omni stre≈ænikom</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create License Modal -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideCreateModal()">&times;</span>
            <h2>‚ûï Ustvari novo licenco</h2>
            <form id="createForm">
                <div class="form-group">
                    <label>Ime stranke:</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Produkt:</label>
                    <select id="product" required>
                        <option value="">Izberi produkt</option>
                        <option value="omni-tourism">Omni Tourism</option>
                        <option value="omni-restaurant">Omni Restaurant</option>
                        <option value="omni-agriculture">Omni Agriculture</option>
                        <option value="omni-health">Omni Health</option>
                        <option value="omni-full">Omni Full Suite</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Paket:</label>
                    <select id="plan" required>
                        <option value="">Izberi paket</option>
                        <option value="basic">Basic</option>
                        <option value="pro">Pro</option>
                        <option value="enterprise">Enterprise</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Veljavnost (dni):</label>
                    <input type="number" id="durationDays" value="365" min="1">
                </div>
                <button type="submit" class="btn btn-primary">üöÄ Ustvari licenco</button>
            </form>
        </div>
    </div>
    
    <script>
        let licenses = [];
        let eventSource;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventSource();
            refreshLicenses();
            refreshStats();
        });
        
        // Server-Sent Events for real-time updates
        function initializeEventSource() {
            eventSource = new EventSource('/events');
            
            // Global WebSocket connection (for production deployment)
            let globalSocket = null;
            
            // Try to connect to global WebSocket server
            function connectGlobalWebSocket() {
                try {
                    // Replace with your domain in production
                    const globalServerUrl = window.location.protocol === 'https:' 
                        ? 'wss://yourdomain.com:3000' 
                        : 'ws://localhost:3100';
                    
                    globalSocket = new WebSocket(globalServerUrl);
                    
                    globalSocket.onopen = function() {
                        console.log('üåê Connected to Global Omni Server');
                        addActivityItem({
                            action: 'system',
                            message: 'Connected to Global Server'
                        });
                    };
                    
                    globalSocket.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        console.log('üåê Global update:', data);
                        
                        if (data.type === 'license_update') {
                            addActivityItem({
                                action: data.action || 'updated',
                                message: `Global License ${data.action || 'updated'}: ${data.license_key || 'Unknown'}`
                            });
                            refreshLicenses();
                            refreshStats();
                        }
                    };
                    
                    globalSocket.onclose = function() {
                        console.log('üåê Disconnected from Global Server');
                        addActivityItem({
                            action: 'system',
                            message: 'Disconnected from Global Server - Reconnecting...'
                        });
                        // Reconnect after 5 seconds
                        setTimeout(connectGlobalWebSocket, 5000);
                    };
                    
                    globalSocket.onerror = function(error) {
                        console.log('üåê Global WebSocket error, using local connection');
                    };
                    
                } catch (error) {
                    console.log('üåê Global WebSocket not available, using local connection');
                }
            }
            
            // Connect to global WebSocket
            connectGlobalWebSocket();
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('üì° Local update:', data);
                addActivityItem(data);
                refreshLicenses();
                refreshStats();
            };
            
            eventSource.onerror = function(event) {
                addActivityItem({
                    action: 'error',
                    message: 'Povezava z stre≈ænikom prekinjena'
                });
            };
        }
        
        // Load licenses
        async function refreshLicenses() {
            try {
                const response = await fetch('/api/license');
                const data = await response.json();
                
                // Handle different response formats
                if (Array.isArray(data)) {
                    licenses = data;
                } else if (data.licenses && Array.isArray(data.licenses)) {
                    licenses = data.licenses;
                } else if (data.data && Array.isArray(data.data)) {
                    licenses = data.data;
                } else {
                    console.warn('Unexpected license data format:', data);
                    licenses = [];
                }
                
                renderLicenses();
            } catch (error) {
                console.error('Error loading licenses:', error);
                licenses = [];
                document.getElementById('licensesContainer').innerHTML = 
                    '<p style="color: red;">Napaka pri nalaganju licenc</p>';
            }
        }
        
        // Load statistics
        async function refreshStats() {
            try {
                const response = await fetch('/api/license/stats/overview');
                const stats = await response.json();
                
                document.getElementById('totalLicenses').textContent = stats.totalLicenses || 0;
                
                const statusStats = stats.statusStats || [];
                const activeCount = statusStats.find(s => s._id === 'active')?.count || 0;
                const expiredCount = statusStats.find(s => s._id === 'expired')?.count || 0;
                
                document.getElementById('activeLicenses').textContent = activeCount;
                document.getElementById('expiredLicenses').textContent = expiredCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Render licenses table
        function renderLicenses() {
            const container = document.getElementById('licensesContainer');
            
            if (licenses.length === 0) {
                container.innerHTML = '<p>Ni najdenih licenc</p>';
                return;
            }
            
            const table = `
                <table class="licenses-table">
                    <thead>
                        <tr>
                            <th>Licenƒçni kljuƒç</th>
                            <th>Stranka</th>
                            <th>Produkt</th>
                            <th>Status</th>
                            <th>Poteƒçe</th>
                            <th>Akcije</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${licenses.map(license => `
                            <tr>
                                <td><code>${license.licenseKey}</code></td>
                                <td>${license.clientName}</td>
                                <td>${license.product}</td>
                                <td><span class="status-badge status-${license.status}">${license.status}</span></td>
                                <td>${new Date(license.expiresAt).toLocaleDateString('sl-SI')}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="revokeLicense('${license.licenseKey}')">üö´ Prekliƒçi</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        // Filter licenses
        function filterLicenses() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filteredLicenses = licenses.filter(license => 
                license.clientName.toLowerCase().includes(searchTerm) ||
                license.licenseKey.toLowerCase().includes(searchTerm) ||
                license.product.toLowerCase().includes(searchTerm)
            );
            
            // Temporarily replace licenses for rendering
            const originalLicenses = licenses;
            licenses = filteredLicenses;
            renderLicenses();
            licenses = originalLicenses;
        }
        
        // Create license modal
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'block';
        }
        
        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createForm').reset();
        }
        
        // Create license
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                clientName: document.getElementById('clientName').value,
                email: document.getElementById('email').value,
                product: document.getElementById('product').value,
                plan: document.getElementById('plan').value,
                durationDays: parseInt(document.getElementById('durationDays').value)
            };
            
            try {
                const response = await fetch('/api/license', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    hideCreateModal();
                    refreshLicenses();
                    refreshStats();
                    addActivityItem({
                        action: 'created',
                        message: `Nova licenca ustvarjena za ${formData.clientName}`
                    });
                } else {
                    alert('Napaka pri ustvarjanju licence');
                }
            } catch (error) {
                console.error('Error creating license:', error);
                alert('Napaka pri ustvarjanju licence');
            }
        });
        
        // Revoke license
        async function revokeLicense(licenseKey) {
            if (!confirm('Ali ste prepriƒçani, da ≈æelite preklicati to licenco?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/license/${licenseKey}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    refreshLicenses();
                    refreshStats();
                    addActivityItem({
                        action: 'revoked',
                        message: `Licenca ${licenseKey} preklicana`
                    });
                } else {
                    alert('Napaka pri preklicu licence');
                }
            } catch (error) {
                console.error('Error revoking license:', error);
                alert('Napaka pri preklicu licence');
            }
        }
        
        // Add activity item
        function addActivityItem(data) {
            const feed = document.getElementById('activityFeed');
            const time = new Date().toLocaleTimeString('sl-SI');
            
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-time">${time}</div>
                <div>${data.message || `${data.action}: ${data.license?.clientName || 'Unknown'}`}</div>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 10 items
            while (feed.children.length > 10) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('createModal');
            if (event.target === modal) {
                hideCreateModal();
            }
        }
    </script>
</body>
</html>